<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#000}
#map{height:100vh;width:100vw}
.btn{position:fixed;z-index:1000;padding:15px 20px;border:none;border-radius:25px;font-weight:600;font-size:16px;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
#emergency{top:20px;left:20px;background:#ff4444;color:white;width:120px}
#routes{bottom:20px;left:20px;background:#4a90e2;color:white;width:160px;padding:15px;border-radius:20px}
.route-btn{display:block;width:100%;margin:5px 0;padding:10px;background:rgba(255,255,255,0.2);border:none;border-radius:20px;color:white;font-size:14px}
.staff-count{top:10px;right:20px;background:rgba(255,0,0,0.9);color:white;padding:10px;border-radius:20px;font-size:14px;font-weight:bold}
#user-status{top:90px;left:20px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:15px;font-size:12px}
</style>
</head>
<body>
<div id="map"></div>
<button id="emergency" onclick="sendEmergency()">ğŸš¨æ±‚æ•‘</button>
<div id="user-status" style="display:none">âœ…æ±‚æ•‘å·²ç™¼é€ (é»æ“Šå–æ¶ˆ)</div>
<div id="routes">
    <div style="font-weight:bold;margin-bottom:10px">ğŸƒ è·¯ç·š</div>
    <button class="route-btn" onclick="showRoute('red')">ğŸ”´ç´…ç·š</button>
    <button class="route-btn" onclick="showRoute('green')">ğŸŸ¢ç¶ ç·š</button>
    <button class="route-btn" onclick="showRoute('blue')">ğŸ”µè—ç·š</button>
</div>
<div class="staff-count" id="staff-count">ğŸ‘¥è¼‰å…¥ä¸­...</div>

<script>
const map=L.map('map').setView([22.4,114.12],13)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map)

const socket=io({transports: ['websocket']})
let routeLayers={}
let staffMarkers={}
const routes=JSON.parse('<%- JSON.stringify(routes) %>')
const userId='u'+Math.random().toString(36).slice(2,7)

Object.entries(routes).forEach(([color,points])=>{
    routeLayers[color]=L.polyline(points,{
        color:color==='red'?'#f44':color==='green'?'#4f4':'#44f',
        weight:6
    }).addTo(map)
    routeLayers[color].options.opacity=0.4
})

function showRoute(color){
    Object.values(routeLayers).forEach(l=>l.setStyle({opacity:0.4}))
    routeLayers[color].setStyle({opacity:1})
    map.fitBounds(routeLayers[color].getBounds())
}

socket.on('staff_update',data=>{
    if(staffMarkers[data.staffId]){
        staffMarkers[data.staffId].setLatLng([data.lat,data.lng])
        staffMarkers[data.staffId].setStyle({
            radius:14,
            color:data.mode==='bike'?'#ffaa00':'#ff4444',
            fillColor:data.mode==='bike'?'#ffaa00':'#ff4444',
            fillOpacity:data.firstaid?0.9:0.7,
            weight:4
        })
    }else{
        staffMarkers[data.staffId]=L.circleMarker([data.lat,data.lng],{
            radius:14,
            color:data.mode==='bike'?'#ffaa00':'#ff4444',
            fillColor:data.mode==='bike'?'#ffaa00':'#ff4444',
            fillOpacity:data.firstaid?0.9:0.7,
            weight:4
        }).addTo(map).bindPopup(
            `${data.mode==='bike'?'ğŸš´è‡ªè¡Œè»Š':'ğŸš¶æ­¥è¡Œ'}${data.firstaid?' + ğŸ©¹æ€¥æ•‘åŒ…':''}`
        )
    }
    document.getElementById('staff-count').textContent=`ğŸ‘¥${Object.keys(staffMarkers).length}äºº`
})

let emergency
