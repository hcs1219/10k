<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Tracker - Staff View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #map { height: calc(100vh - 220px); }
        .user-icon { background-color: #3B82F6; }
        .emergency-user { background-color: #EF4444; animation: pulse 1.5s infinite; }
        .staff-icon-walk { background-color: #F97316; }
        .staff-icon-bike { background-color: #F59E0B; }
        .staff-icon-firstaid { background-color: #DC2626; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-2">
        <!-- Header -->
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-2xl font-bold text-orange-700">Staff Dashboard</h1>
            <div class="flex items-center space-x-2">
                <span id="status" class="px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm">Connected</span>
                <button onclick="window.location.href='/'" class="px-3 py-1 bg-gray-200 rounded-lg text-sm">
                    Runner View
                </button>
            </div>
        </div>

        <!-- Staff Controls -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
            <!-- Location Sharing Toggle -->
            <div class="bg-white p-3 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Share Location</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="shareLocation" checked class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <!-- Transportation Mode -->
            <div class="bg-white p-3 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-1">Transport</label>
                <select id="transportMode" class="w-full text-sm border-gray-300 rounded-lg">
                    <option value="walk">üö∂ Walk</option>
                    <option value="bike">üö¥ Bike</option>
                </select>
            </div>

            <!-- First Aid Toggle -->
            <div class="bg-white p-3 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">First Aid Kit</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="firstAid" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
            </div>

            <!-- Update Button -->
            <div class="bg-white p-3 rounded-lg border border-gray-200 flex items-center">
                <button onclick="updateStaffStatus()" class="w-full py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg text-sm">
                    Update Status
                </button>
            </div>
        </div>

        <!-- Emergency Alerts -->
        <div id="emergencyAlerts" class="mb-3 space-y-2">
            <!-- Emergency alerts will appear here -->
        </div>

        <!-- Map Container -->
        <div id="map" class="rounded-xl border-2 border-gray-300 shadow-lg mb-3"></div>

        <!-- Legend -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-blue-500 mr-2"></div>
                <span class="text-sm">Runners</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-orange-500 mr-2"></div>
                <span class="text-sm">Staff (Walk)</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-amber-500 mr-2"></div>
                <span class="text-sm">Staff (Bike)</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                <span class="text-sm">First Aid</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-500 mr-2 animate-pulse"></div>
                <span class="text-sm">Emergency</span>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let socket = io();
        let map = null;
        let staffMarker = null;
        let userMarkers = {};
        let staffMarkers = {};
        let watchId = null;
        let staffPosition = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([1.3521, 103.8198], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            startLocationTracking();
            socket.emit('get_all_data');
        }

        // Start tracking staff location
        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        staffPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        updateStaffLocation();
                        
                        if (!staffMarker) {
                            createStaffMarker();
                        } else {
                            staffMarker.setLatLng([staffPosition.lat, staffPosition.lng]);
                        }
                        
                        if (!map.getBounds().contains(staffMarker.getLatLng())) {
                            map.panTo([staffPosition.lat, staffPosition.lng]);
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 10000,
                        timeout: 5000
                    }
                );
            }
        }

        // Create staff marker
        function createStaffMarker() {
            const transport = document.getElementById('transportMode').value;
            const firstAid = document.getElementById('firstAid').checked;
            
            let iconClass = 'staff-icon-walk';
            let iconText = 'üë®‚Äç‚öïÔ∏è';
            
            if (transport === 'bike') {
                iconClass = 'staff-icon-bike';
                iconText = 'üö¥';
            }
            
            if (firstAid) {
                iconClass = 'staff-icon-firstaid';
                iconText = 'ü©π';
            }
            
            staffMarker = L.marker([staffPosition.lat, staffPosition.lng], {
                icon: L.divIcon({
                    html: `<div class="w-12 h-12 rounded-full flex items-center justify-center text-xl ${iconClass} border-2 border-white shadow-lg">${iconText}</div>`,
                    className: 'custom-div-icon',
                    iconSize: [48, 48]
                }),
                zIndexOffset: 1000
            }).addTo(map);
            
            staffMarker.bindTooltip(`You (${transport})${firstAid ? ' - First Aid' : ''}`);
        }

        // Update staff location and status
        function updateStaffLocation() {
            if (staffPosition && document.getElementById('shareLocation').checked) {
                socket.emit('staff_location', {
                    lat: staffPosition.lat,
                    lng: staffPosition.lng,
                    transport: document.getElementById('transportMode').value,
                    share_location: document.getElementById('shareLocation').checked,
                    first_aid: document.getElementById('firstAid').checked
                });
            }
        }

        // Update staff status manually
        function updateStaffStatus() {
            if (staffMarker) {
                map.removeLayer(staffMarker);
                staffMarker = null;
            }
            if (staffPosition) {
                createStaffMarker();
                updateStaffLocation();
            }
            
            showNotification('Status updated successfully!');
        }

        // Socket event handlers
        socket.on('connect', () => {
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('status').className = 'px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm';
        });

        socket.on('disconnect', () => {
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'px-3 py-1 rounded-full bg-red-100 text-red-800 text-sm';
        });

        socket.on('all_data', (data) => {
            // Clear existing markers
            Object.values(userMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(staffMarkers).forEach(marker => map.removeLayer(marker));
            userMarkers = {};
            staffMarkers = {};
            
            // Add user markers
            Object.entries(data.users).forEach(([sid, userData]) => {
                if (sid !== socket.id) {
                    addUserMarker(sid, userData);
                }
            });
            
            // Add other staff markers
            Object.entries(data.staff).forEach(([sid, staffData]) => {
                if (sid !== socket.id && staffData.share_location) {
                    addStaffMarker(sid, staffData);
                }
            });
            
            // Show emergency alerts
            Object.entries(data.emergencies).forEach(([eid, emergency]) => {
                showEmergencyAlert(eid, emergency);
            });
        });

        socket.on('user_update', (userData) => {
            if (userData.sid !== socket.id) {
                addUserMarker(userData.sid || socket.id, userData);
            }
        });

        socket.on('staff_update', (staffData) => {
            if (staffData.sid !== socket.id) {
                if (staffData.share_location) {
                    addStaffMarker(staffData.sid || socket.id, staffData);
                } else if (staffMarkers[staffData.sid || socket.id]) {
                    map.removeLayer(staffMarkers[staffData.sid || socket.id]);
                    delete staffMarkers[staffData.sid || socket.id];
                }
            }
        });

        socket.on('user_left', (data) => {
            if (userMarkers[data.sid]) {
                map.removeLayer(userMarkers[data.sid]);
                delete userMarkers[data.sid];
            }
        });

        socket.on('staff_left', (data) => {
            if (staffMarkers[data.sid]) {
                map.removeLayer(staffMarkers[data.sid]);
                delete staffMarkers[data.sid];
            }
        });

        socket.on('emergency_alert', (data) => {
            showEmergencyAlert(data.emergency_id, {
                user_id: data.user_id,
                location: data.location
            });
            showNotification(`EMERGENCY! User ${data.user_id.slice(0,4)} needs help!`);
            
            // Update user marker to emergency
            if (userMarkers[data.user_id]) {
                userMarkers[data.user_id].setStyle({
                    fillColor: '#EF4444',
                    color: '#DC2626',
                    className: 'emergency-user'
                });
            }
        });

        socket.on('emergency_resolved', (data) => {
            removeEmergencyAlert(data.emergency_id);
            
            // Update user marker back to normal
            if (userMarkers[data.user_id]) {
                userMarkers[data.user_id].setStyle({
                    fillColor: '#3B82F6',
                    color: '#1D4ED8',
                    className: ''
                });
            }
        });

        // Add user marker
        function addUserMarker(sid, data) {
            const marker = L.circleMarker([data.location[0], data.location[1]], {
                radius: 8,
                fillColor: data.emergency ? '#EF4444' : '#3B82F6',
                color: data.emergency ? '#DC2626' : '#1D4ED8',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8,
                className: data.emergency ? 'emergency-user' : ''
            }).addTo(map);
            
            marker.bindTooltip(`${data.name}${data.emergency ? ' - EMERGENCY!' : ''}`);
            
            if (userMarkers[sid]) {
                userMarkers[sid].setLatLng([data.location[0], data.location[1]]);
            } else {
                userMarkers[sid] = marker;
            }
        }

        // Add staff marker
        function addStaffMarker(sid, data) {
            let iconClass = 'staff-icon-walk';
            let iconText = 'üë®‚Äç‚öïÔ∏è';
            
            if (data.transport === 'bike') {
                iconClass = 'staff-icon-bike';
                iconText = 'üö¥';
            }
            
            if (data.first_aid) {
                iconClass = 'staff-icon-firstaid';
                iconText = 'ü©π';
            }
            
            const marker = L.marker([data.location[0], data.location[1]], {
                icon: L.divIcon({
                    html: `<div class="w-10 h-10 rounded-full flex items-center justify-center text-lg ${iconClass} border-2 border-white shadow-lg">${iconText}</div>`,
                    className: 'custom-div-icon',