<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Control ‚Äì RunGuard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
  <style>#map { height: 60vh; min-height: 380px; }</style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <header class="bg-gray-800 text-white p-4 text-center font-bold text-lg">
    Staff Dashboard ‚Äì Live Overview
  </header>

  <main class="flex-1 p-4 flex flex-col gap-4">
    <div id="map" class="w-full rounded shadow"></div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <label class="flex items-center gap-2 bg-white p-3 rounded shadow">
        <input type="checkbox" id="shareLoc" checked class="w-5 h-5">
        <span>Share location</span>
      </label>
      <label class="flex items-center gap-2 bg-white p-3 rounded shadow">
        <input type="checkbox" id="firstAid" class="w-5 h-5">
        <span>Have First Aid Kit</span>
      </label>
      <div class="flex items-center gap-2 bg-white p-3 rounded shadow">
        <span>Transport:</span>
        <select id="transport" class="border rounded px-2 py-1">
          <option value="walk">Walk</option>
          <option value="bike">Bike</option>
        </select>
      </div>
      <div class="flex items-center gap-2 bg-white p-3 rounded shadow">
        <span>Name:</span>
        <input id="staffName" type="text" value="Staff" class="border rounded px-2 py-1 w-24">
      </div>
    </div>

    <div id="status" class="text-center text-sm text-gray-600">Waiting for location‚Ä¶</div>
  </main>

  <script>
    const socket = io();

    let map, myMarker;

    function initMap() {
      map = L.map('map').setView([22.300, 114.170], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
    }

    function sendStaffState() {
      const share = document.getElementById('shareLoc').checked;
      socket.emit('update_location', {
        role: 'staff',
        lat: share ? undefined : null,
        lng: share ? undefined : null,
        name: document.getElementById('staffName').value.trim() || 'Staff',
        transport: document.getElementById('transport').value,
        first_aid: document.getElementById('firstAid').checked,
        share_location: share
      });
    }

    socket.on('connect', () => {
      document.getElementById('status').textContent = "Connected";
    });

    socket.on('update_all', data => {
      map.eachLayer(l => {
        if (l instanceof L.Marker && l !== myMarker) map.removeLayer(l);
      });

      Object.values(data.participants || {}).forEach(p => {
        if (!p.lat) return;
        L.circleMarker([p.lat, p.lng], {
          radius:9,
          color: p.emergency ? 'red' : 'blue',
          fillColor: p.emergency ? '#ef4444' : '#dbeafe',
          fillOpacity:0.9,
          weight: p.emergency ? 4 : 2
        }).addTo(map).bindTooltip(p.name || 'Runner' + (p.emergency ? ' ‚ö†Ô∏è' : ''));
      });

      Object.entries(data.staff || {}).forEach(([sid, s]) => {
        if (sid === socket.id || !s.lat || !s.share_location) return;
        const color = s.first_aid ? 'red' : 'orange';
        const icon = s.transport === 'bike' ? 'üö¥‚Äç‚ôÇÔ∏è' : 'üö∂';
        L.marker([s.lat, s.lng], {
          icon: L.divIcon({html:`<div class="text-3xl">${icon}</div>`, iconSize:[48,48], iconAnchor:[24,48]})
        }).addTo(map).bindTooltip(s.name || 'Staff' + (s.first_aid ? ' ü©π' : ''));
      });
    });

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          const {latitude: lat, longitude: lng} = pos.coords;
          const share = document.getElementById('shareLoc').checked;
          if (share) {
            socket.emit('update_location', {role:'staff', lat, lng,
              name: document.getElementById('staffName').value.trim() || 'Staff',
              transport: document.getElementById('transport').value,
              first_aid: document.getElementById('firstAid').checked,
              share_location: true
            });
            if (!myMarker) {
              myMarker = L.marker([lat,lng]).addTo(map);
              map.setView([lat,lng], 16);
            } else {
              myMarker.setLatLng([lat,lng]);
            }
            document.getElementById('status').textContent = `Location shared ‚Ä¢ ${new Date().toLocaleTimeString()}`;
          }
        },
        err => document.getElementById('status').textContent = `Location error: ${err.message}`,
        {enableHighAccuracy:true, maximumAge:0}
      );
    }

    ['shareLoc','firstAid','transport','staffName'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.onchange = sendStaffState;
        if (id === 'staffName') el.oninput = sendStaffState;
      }
    });

    initMap();
  </script>
</body>
</html>