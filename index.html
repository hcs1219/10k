<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·‘æ­¥è¿½è¹¤ - è·‘è€…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #map { height: 60vh; }
        .runner-icon { background: #3B82F6; }
        .crew-icon-walk { background: #F97316; }
        .crew-icon-bike { background: #F59E0B; }
        .crew-icon-firstaid { background: #DC2626; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-2">
        <!-- æ¨™é¡Œ -->
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-gray-900">è·‘æ­¥è¿½è¹¤</h1>
            <div class="flex items-center">
                <span id="connectionStatus" class="px-2 py-1 rounded-full bg-gray-100">
                    <i class="fas fa-wifi text-gray-500"></i>
                </span>
            </div>
        </div>

        <!-- è·¯ç·šé¸æ“‡ -->
        <div class="mb-3">
            <div class="flex space-x-2 overflow-x-auto pb-2">
                <button onclick="selectRoute('route_2k')" id="route_2k" 
                        class="route-btn flex-shrink-0 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">
                    2km è·¯ç·š
                </button>
                <button onclick="selectRoute('route_5k')" id="route_5k" 
                        class="route-btn flex-shrink-0 px-3 py-2 bg-green-500 text-white rounded-lg text-sm">
                    5km è·¯ç·š
                </button>
                <button onclick="selectRoute('route_10k')" id="route_10k" 
                        class="route-btn flex-shrink-0 px-3 py-2 bg-purple-500 text-white rounded-lg text-sm">
                    10km è·¯ç·š
                </button>
            </div>
        </div>

        <!-- ç·Šæ€¥æŒ‰éˆ• -->
        <div class="mb-3">
            <button id="emergencyBtn" onclick="requestEmergency()" 
                    class="w-full py-3 px-4 bg-red-500 text-white font-bold rounded-lg">
                ç·Šæ€¥æ±‚åŠ©
            </button>
            <button id="cancelEmergencyBtn" onclick="cancelEmergency()" 
                    class="hidden w-full py-3 px-4 bg-green-500 text-white font-bold rounded-lg mt-2">
                å–æ¶ˆæ±‚åŠ©
            </button>
        </div>

        <!-- åœ°åœ– -->
        <div id="map" class="rounded-lg border border-gray-300"></div>

        <!-- ä½ç½®è³‡è¨Š -->
        <div class="mt-3 p-3 bg-white rounded-lg border border-gray-200">
            <div class="text-sm text-gray-600">æ‚¨çš„ä½ç½®</div>
            <div id="currentLocation" class="font-mono text-sm">å–å¾—ä½ç½®ä¸­...</div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let socket = null;
        let map = null;
        let runnerMarker = null;
        let crewMarkers = {};
        let userMarkers = {};
        let currentRoute = 'route_2k';
        let userPosition = null;
        let emergencyId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initWebSocket();
            startLocationTracking();
        });

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = L.map('map').setView([25.0338, 121.5645], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            
            loadRoutes();
        }

        // è¼‰å…¥è·¯ç·š
        async function loadRoutes() {
            try {
                const response = await fetch('/api/routes');
                window.routes = await response.json();
                selectRoute('route_2k');
            } catch (error) {
                console.error('è¼‰å…¥è·¯ç·šå¤±æ•—:', error);
            }
        }

        // é¸æ“‡è·¯ç·š
        function selectRoute(routeId) {
            currentRoute = routeId;
            
            // æ›´æ–°æŒ‰éˆ•
            document.querySelectorAll('.route-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
            });
            event.target.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
            
            // é¡¯ç¤ºè·¯ç·š
            if (window.routeLayer) {
                map.removeLayer(window.routeLayer);
            }
            
            const route = window.routes[routeId];
            if (route && route.path) {
                window.routeLayer = L.polyline(route.path, {
                    color: route.color,
                    weight: 4
                }).addTo(map);
                map.fitBounds(window.routeLayer.getBounds());
            }
        }

        // ä½ç½®è¿½è¹¤
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showMessage('è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                return;
            }
            
            navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                { enableHighAccuracy: true }
            );
            
            setInterval(sendLocationUpdate, 10000);
        }

        function handlePositionUpdate(position) {
            userPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            updateLocationDisplay();
            updateRunnerMarker();
            sendLocationUpdate();
        }

        function handlePositionError(error) {
            console.error('å®šä½éŒ¯èª¤:', error);
            showMessage('ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æª¢æŸ¥å®šä½è¨­å®š');
        }

        function updateLocationDisplay() {
            if (userPosition) {
                document.getElementById('currentLocation').textContent = 
                    `${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}`;
            }
        }

        function updateRunnerMarker() {
            if (!userPosition) return;
            
            if (!runnerMarker) {
                runnerMarker = L.circleMarker([userPosition.lat, userPosition.lng], {
                    radius: 10,
                    fillColor: emergencyId ? '#EF4444' : '#3B82F6',
                    color: '#1D4ED8',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);
            } else {
                runnerMarker.setLatLng([userPosition.lat, userPosition.lng]);
                runnerMarker.setStyle({
                    fillColor: emergencyId ? '#EF4444' : '#3B82F6'
                });
            }
            
            if (!map.getBounds().contains(runnerMarker.getLatLng())) {
                map.panTo([userPosition.lat, userPosition.lng]);
            }
        }

        // WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketUrl = `${protocol}//${host}`;
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            // äº‹ä»¶è™•ç†
            socket.on('connect', handleSocketConnect);
            socket.on('disconnect', handleSocketDisconnect);
            socket.on('connected', handleConnected);
            socket.on('registration_success', handleRegistrationSuccess);
            socket.on('initial_data', handleInitialData);
            socket.on('user_location_updated', handleUserLocationUpdated);
            socket.on('crew_location_updated', handleCrewLocationUpdated);
            socket.on('user_joined', handleUserJoined);
            socket.on('user_left', handleUserLeft);
            socket.on('crew_joined', handleCrewJoined);
            socket.on('crew_left', handleCrewLeft);
            socket.on('emergency_alert', handleEmergencyAlert);
            socket.on('emergency_confirmed', handleEmergencyConfirmed);
            socket.on('emergency_resolved', handleEmergencyResolved);
        }

        function handleSocketConnect() {
            updateConnectionStatus('bg-yellow-500');
        }

        function handleSocketDisconnect() {
            updateConnectionStatus('bg-red-500');
        }

        function handleConnected(data) {
            updateConnectionStatus('bg-green-500');
            
            socket.emit('register_user', {
                location: userPosition ? [userPosition.lat, userPosition.lng] : [25.0338, 121.5645]
            });
            
            socket.emit('get_initial_data');
        }

        function handleRegistrationSuccess(data) {
            console.log('è¨»å†ŠæˆåŠŸ');
        }

        function handleInitialData(data) {
            // æ¸…é™¤èˆŠæ¨™è¨˜
            Object.values(crewMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(userMarkers).forEach(marker => map.removeLayer(marker));
            crewMarkers = {};
            userMarkers = {};
            
            // æ·»åŠ å…¶ä»–è·‘è€…
            Object.entries(data.users).forEach(([userId, user]) => {
                addUserMarker(userId, user);
            });
            
            // æ·»åŠ å·¥ä½œäººå“¡
            Object.entries(data.crew).forEach(([crewId, crew]) => {
                addCrewMarker(crewId, crew);
            });
        }

        function handleUserLocationUpdated(data) {
            if (userMarkers[data.sid]) {
                userMarkers[data.sid].setLatLng([data.location[0], data.location[1]]);
            } else {
                addUserMarker(data.sid, data);
            }
        }

        function handleCrewLocationUpdated(data) {
            if (crewMarkers[data.sid]) {
                crewMarkers[data.sid].setLatLng([data.location[0], data.location[1]]);
            } else {
                addCrewMarker(data.sid, data);
            }
        }

        function addUserMarker(userId, user) {
            const marker = L.circleMarker([user.location[0], user.location[1]], {
                radius: 6,
                fillColor: '#3B82F6',
                color: '#1D4ED8',
                weight: 1,
                fillOpacity: 0.6
            }).addTo(map);
            
            marker.bindTooltip(user.name);
            userMarkers[userId] = marker;
        }

        function addCrewMarker(crewId, crew) {
            let iconClass = 'crew-icon-walk';
            let iconText = 'ğŸ‘¨â€âš•ï¸';
            
            if (crew.transport === 'bike') {
                iconClass = 'crew-icon-bike';
                iconText = 'ğŸš´';
            }
            
            if (crew.first_aid) {
                iconClass = 'crew-icon-firstaid';
                iconText = 'ğŸ©¹';
            }
            
            const marker = L.marker([crew.location[0], crew.location[1]], {
                icon: L.divIcon({
                    html: `<div class="w-8 h-8 rounded-full ${iconClass} flex items-center justify-center">${iconText}</div>`,
                    className: 'custom-div-icon',
                    iconSize: [32, 32]
                })
            }).addTo(map);
            
            marker.bindTooltip(crew.name);
            crewMarkers[crewId] = marker;
        }

        // ç·Šæ€¥åŠŸèƒ½
        function requestEmergency() {
            if (!userPosition) {
                showMessage('è«‹å…ˆå–å¾—ä½ç½®');
                return;
            }
            
            socket.emit('emergency_request', {}, (response) => {
                emergencyId = response.emergency_id;
                document.getElementById('emergencyBtn').classList.add('hidden');
                document.getElementById('cancelEmergencyBtn').classList.remove('hidden');
                updateRunnerMarker();
                showMessage('å·²ç™¼å‡ºç·Šæ€¥æ±‚åŠ©');
            });
        }

        function cancelEmergency() {
            if (!emergencyId) return;
            
            socket.emit('resolve_emergency', { emergency_id: emergencyId }, (response) => {
                if (