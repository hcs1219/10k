<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Tracker - Runner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #map { height: 65vh; }
        .runner-icon { background: #3B82F6; }
        .crew-walk { background: #F97316; }
        .crew-bike { background: #F59E0B; }
        .crew-aid { background: #DC2626; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-2">
        <!-- Header -->
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold text-gray-900">Race Tracker</h1>
            <div class="flex items-center">
                <span id="connectionStatus" class="px-2 py-1">
                    <i class="fas fa-wifi text-gray-500"></i>
                </span>
            </div>
        </div>

        <!-- Route Selection -->
        <div class="mb-2">
            <div class="flex space-x-1">
                <button onclick="selectRoute('route_2k')" id="route_2k" 
                        class="flex-1 py-1 bg-blue-500 text-white rounded text-sm">
                    2km
                </button>
                <button onclick="selectRoute('route_5k')" id="route_5k" 
                        class="flex-1 py-1 bg-green-500 text-white rounded text-sm">
                    5km
                </button>
                <button onclick="selectRoute('route_10k')" id="route_10k" 
                        class="flex-1 py-1 bg-purple-500 text-white rounded text-sm">
                    10km
                </button>
            </div>
        </div>

        <!-- Emergency Button -->
        <div class="mb-2">
            <button id="emergencyBtn" onclick="requestEmergency()" 
                    class="w-full py-2 bg-red-500 text-white font-bold rounded">
                EMERGENCY
            </button>
            <button id="cancelEmergencyBtn" onclick="cancelEmergency()" 
                    class="hidden w-full py-2 bg-green-500 text-white font-bold rounded mt-1">
                CANCEL
            </button>
        </div>

        <!-- Map -->
        <div id="map" class="rounded border border-gray-300"></div>

        <!-- Location -->
        <div class="mt-2 p-2 bg-white rounded border border-gray-200">
            <div class="text-xs text-gray-600">Your Location</div>
            <div id="currentLocation" class="font-mono text-xs">Getting location...</div>
        </div>
    </div>

    <script>
        // Variables
        let socket = null;
        let map = null;
        let runnerMarker = null;
        let crewMarkers = {};
        let userMarkers = {};
        let currentRoute = 'route_2k';
        let userPosition = null;
        let emergencyId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initWebSocket();
            startLocationTracking();
        });

        // Initialize map
        function initMap() {
            map = L.map('map').setView([25.0338, 121.5645], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            
            loadRoutes();
        }

        // Load routes
        async function loadRoutes() {
            try {
                const response = await fetch('/api/routes');
                window.routes = await response.json();
                selectRoute('route_2k');
            } catch (error) {
                console.error('Failed to load routes:', error);
            }
        }

        // Select route
        function selectRoute(routeId) {
            currentRoute = routeId;
            
            // Update buttons
            document.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('ring-1', 'ring-white');
            });
            event.target.classList.add('ring-1', 'ring-white');
            
            // Show route
            if (window.routeLayer) {
                map.removeLayer(window.routeLayer);
            }
            
            const route = window.routes[routeId];
            if (route && route.path) {
                window.routeLayer = L.polyline(route.path, {
                    color: route.color,
                    weight: 3
                }).addTo(map);
                map.fitBounds(window.routeLayer.getBounds());
            }
        }

        // Location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showMessage('GPS not supported');
                return;
            }
            
            navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                { enableHighAccuracy: true }
            );
            
            setInterval(sendLocationUpdate, 10000);
        }

        function handlePositionUpdate(position) {
            userPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            updateLocationDisplay();
            updateRunnerMarker();
            sendLocationUpdate();
        }

        function handlePositionError(error) {
            console.error('GPS error:', error);
            showMessage('GPS error');
        }

        function updateLocationDisplay() {
            if (userPosition) {
                document.getElementById('currentLocation').textContent = 
                    `${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}`;
            }
        }

        function updateRunnerMarker() {
            if (!userPosition) return;
            
            if (!runnerMarker) {
                runnerMarker = L.circleMarker([userPosition.lat, userPosition.lng], {
                    radius: 8,
                    fillColor: emergencyId ? '#EF4444' : '#3B82F6',
                    color: '#1D4ED8',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);
            } else {
                runnerMarker.setLatLng([userPosition.lat, userPosition.lng]);
                runnerMarker.setStyle({
                    fillColor: emergencyId ? '#EF4444' : '#3B82F6'
                });
            }
        }

        // WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketUrl = `${protocol}//${host}`;
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            // Event handlers
            socket.on('connect', handleSocketConnect);
            socket.on('disconnect', handleSocketDisconnect);
            socket.on('connected', handleConnected);
            socket.on('registration_success', handleRegistrationSuccess);
            socket.on('initial_data', handleInitialData);
            socket.on('user_location_updated', handleUserLocationUpdated);
            socket.on('crew_location_updated', handleCrewLocationUpdated);
            socket.on('user_joined', handleUserJoined);
            socket.on('user_left', handleUserLeft);
            socket.on('crew_joined', handleCrewJoined);
            socket.on('crew_left', handleCrewLeft);
            socket.on('emergency_alert', handleEmergencyAlert);
            socket.on('emergency_confirmed', handleEmergencyConfirmed);
            socket.on('emergency_resolved', handleEmergencyResolved);
        }

        function handleSocketConnect() {
            updateConnectionStatus('text-yellow-500');
        }

        function handleSocketDisconnect() {
            updateConnectionStatus('text-red-500');
        }

        function handleConnected(data) {
            updateConnectionStatus('text-green-500');
            
            socket.emit('register_user', {
                location: userPosition ? [userPosition.lat, userPosition.lng] : [25.0338, 121.5645]
            });
            
            socket.emit('get_initial_data');
        }

        function handleRegistrationSuccess(data) {
            // No action needed
        }

        function handleInitialData(data) {
            // Clear old markers
            Object.values(crewMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(userMarkers).forEach(marker => map.removeLayer(marker));
            crewMarkers = {};
            userMarkers = {};
            
            // Add other runners
            Object.entries(data.users).forEach(([userId, user]) => {
                addUserMarker(userId, user);
            });
            
            // Add crew
            Object.entries(data.crew).forEach(([crewId, crew]) => {
                addCrewMarker(crewId, crew);
            });
        }

        function handleUserLocationUpdated(data) {
            if (userMarkers[data.sid]) {
                userMarkers[data.sid].setLatLng([data.location[0], data.location[1]]);
            } else {
                addUserMarker(data.sid, data);
            }
        }

        function handleCrewLocationUpdated(data) {
            if (crewMarkers[data.sid]) {
                crewMarkers[data.sid].setLatLng([data.location[0], data.location[1]]);
            } else {
                addCrewMarker(data.sid, data);
            }
        }

        function addUserMarker(userId, user) {
            const marker = L.circleMarker([user.location[0], user.location[1]], {
                radius: 6,
                fillColor: '#3B82F6',
                color: '#1D4ED8',
                weight: 1,
                fillOpacity: 0.6
            }).addTo(map);
            
            userMarkers[userId] = marker;
        }

        function addCrewMarker(crewId, crew) {
            let iconClass = 'crew-walk';
            let iconText = 'W';
            
            if (crew.transport === 'bike') {
                iconClass = 'crew-bike';
                iconText = 'B';
            }
            
            if (crew.first_aid) {
                iconClass = 'crew-aid';
                iconText = 'A';
            }
            
            const marker = L.marker([crew.location[0], crew.location[1]], {
                icon: L.divIcon({
                    html: `<div class="w-6 h-6 rounded-full ${iconClass} flex items-center justify-center text-xs">${iconText}</div>`,
                    className: 'custom-div-icon',
                    iconSize: [24, 24]
                })
            }).addTo(map);
            
            crewMarkers[crewId] = marker;
        }

        // Emergency functions
        function requestEmergency() {
            if (!userPosition) {
                showMessage('Need GPS first');
                return;
            }
            
            socket.emit('emergency_request', {}, (response) => {
                emergencyId = response.emergency_id;
                document.getElementById('emergencyBtn').classList.add('hidden');
                document.getElementById('cancelEmergencyBtn').classList.remove('hidden');
                updateRunnerMarker();
                showMessage('Emergency sent');
            });
        }

        function cancelEmergency() {
            if (!emergencyId) return;
            
            socket.emit('resolve_emergency', { emergency_id: emergencyId }, (response) => {
                emergencyId = null;
                document.getElementById('emergencyBtn').classList.remove('hidden');
                document.getElementById('cancelEmergencyBtn').classList.add('hidden');
                updateRunnerMarker();
                showMessage('Emergency cancelled');
            });
        }

        function handleEmergencyAlert(data) {
            // User doesn't see other emergencies
        }

        function handleEmergencyConfirmed(data) {
            // Confirmation handled in requestEmergency
        }

        function handleEmergencyResolved(data) {
            if (data.user_id === socket.id) {
                emergencyId = null;
                document.getElementById('emergencyBtn').classList.remove('hidden');
                document.getElementById('cancelEmergencyBtn').classList.add('hidden');
                updateRunnerMarker();
            }
        }

        // Other handlers
        function handleUserJoined(data) {
            addUserMarker(data.sid, data);
        }

        function handleUserLeft(data) {
            if (userMarkers[data.sid]) {
                map.removeLayer(userMarkers[data.sid]);
                delete userMarkers[data.sid];
            }
        }

        function handleCrewJoined(data) {
            addCrewMarker(data.sid, data);
        }

        function handleCrewLeft(data) {
            if (crewMarkers[data.sid]) {
                map.removeLayer(crewMarkers[data.sid]);
                delete crewMarkers[data.sid];
            }
        }

        // Utility functions
        function updateConnectionStatus(color) {
            const icon = document.querySelector('#connectionStatus i');
            icon.className = `fas fa-wifi ${color}`;
        }

        function sendLocationUpdate() {
            if (!userPosition || !socket || !socket.connected) return;
            
            socket.emit('user_location_update', {
                lat: userPosition.lat,
                lng: userPosition.lng,
                emergency: emergencyId !== null
            });
        }

        function showMessage(text) {
            // Simple alert for now
            console.log(text);
        }
    </script>
</body>
</html>