<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Runner View â€“ RunGuard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    #map { height: 65vh; min-height: 400px; }
    .emergency { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.15);} 100% {transform:scale(1);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <header class="bg-blue-700 text-white p-4 text-center font-bold text-lg">
    Participant View â€“ Live Race Map
  </header>

  <main class="flex-1 p-3 flex flex-col gap-3">
    <div id="map" class="w-full rounded shadow"></div>

    <div class="flex flex-wrap gap-2 justify-center">
      <button onclick="selectRoute('A')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Route A</button>
      <button onclick="selectRoute('B')" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Route B</button>
      <button onclick="selectRoute('C')" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Route C</button>
    </div>

    <button id="emergencyBtn" class="mt-2 w-full py-5 bg-red-600 hover:bg-red-700 text-white text-xl font-bold rounded-lg shadow-lg transition">
      ðŸš¨ EMERGENCY â€“ NEED HELP
    </button>

    <div id="status" class="text-center text-sm text-gray-600">Waiting for locationâ€¦</div>
  </main>

  <script>
    const socket = io();

    let map, myMarker, markers = {}, routeLayer;
    let emergencyActive = false;
    let currentRoute = 'A';

    const routes = {
      A: [[22.300, 114.170],[22.295, 114.185],[22.285, 114.190],[22.275, 114.175]],
      B: [[22.300, 114.170],[22.310, 114.165],[22.320, 114.180],[22.315, 114.195]],
      C: [[22.300, 114.170],[22.290, 114.155],[22.280, 114.160],[22.275, 114.175]]
    };

    function initMap() {
      map = L.map('map').setView([22.300, 114.170], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(map);
      routeLayer = L.polyline(routes.A, {color:'green', weight:5}).addTo(map);
    }

    function selectRoute(name) {
      currentRoute = name;
      if (routeLayer) map.removeLayer(routeLayer);
      const color = name==='A'?'green':name==='B'?'purple':'orange';
      routeLayer = L.polyline(routes[name], {color, weight:5}).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }

    function startLocation() {
      if (!navigator.geolocation) {
        document.getElementById('status').textContent = "Geolocation not supported";
        return;
      }
      navigator.geolocation.watchPosition(
        pos => {
          const {latitude: lat, longitude: lng} = pos.coords;
          socket.emit('update_location', {role:'participant', lat, lng, name:`Runner-${Math.random().toString(36).slice(2,8)}`});
          if (!myMarker) {
            myMarker = L.circleMarker([lat,lng], {radius:10, color:'blue', fillColor:'#3388ff', fillOpacity:0.8, weight:3})
              .addTo(map);
            map.setView([lat,lng], 16);
          } else {
            myMarker.setLatLng([lat,lng]);
          }
          document.getElementById('status').textContent = `Location shared â€¢ ${new Date().toLocaleTimeString()}`;
        },
        err => document.getElementById('status').textContent = `Location error: ${err.message}`,
        {enableHighAccuracy:true, timeout:5000, maximumAge:0}
      );
    }

    socket.on('connect', () => {
      document.getElementById('status').textContent = "Connected â€“ starting GPSâ€¦";
      startLocation();
    });

    socket.on('update_all', data => {
      Object.keys(markers).forEach(k => { map.removeLayer(markers[k]); delete markers[k]; });

      Object.entries(data.staff || {}).forEach(([sid, s]) => {
        if (!s.share_location || !s.lat) return;
        const color = s.first_aid ? '#dc2626' : '#f59e0b';
        const iconTxt = s.transport==='bike' ? 'ðŸš´' : 'ðŸš¶';
        const m = L.marker([s.lat,s.lng], {
          icon: L.divIcon({html:`<div style="color:${color};font-size:2.2rem">${iconTxt}</div>`, iconSize:[44,44], iconAnchor:[22,44]})
        }).addTo(map).bindTooltip(s.name || 'Staff');
        markers[sid] = m;
      });

      Object.entries(data.participants || {}).forEach(([sid, p]) => {
        if (!p.lat) return;
        const isEmergency = !!p.emergency;
        const m = L.circleMarker([p.lat,p.lng], {
          radius:8,
          color: isEmergency ? 'red' : 'blue',
          fillColor: isEmergency ? '#ef4444' : '#3b82f6',
          fillOpacity:0.7,
          weight: isEmergency ? 4 : 2,
          className: isEmergency ? 'emergency' : ''
        }).addTo(map).bindTooltip(p.name || 'Runner');
        markers[sid] = m;
      });
    });

    socket.on('emergency_alert', data => {
      alert(`Emergency from ${data.name || 'a runner'}!`);
    });

    document.getElementById('emergencyBtn').onclick = function() {
      if (emergencyActive) {
        socket.emit('cancel_emergency');
        if (myMarker) myMarker.setStyle({color:'blue', fillColor:'#3388ff'});
        this.textContent = "ðŸš¨ EMERGENCY â€“ NEED HELP";
        emergencyActive = false;
      } else if (myMarker) {
        const pos = myMarker.getLatLng();
        socket.emit('emergency', {lat: pos.lat, lng: pos.lng});
        myMarker.setStyle({color:'red', fillColor:'#ef4444'});
        this.textContent = "ðŸš¨ CANCEL HELP REQUEST";
        emergencyActive = true;
      }
    };

    initMap();
    selectRoute('A');
  </script>
</body>
</html>