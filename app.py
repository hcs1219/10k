from flask import Flask, render_template, request, jsonify
from flask_socketio import SocketIO, emit
from flask_cors import CORS
import json
import time
from datetime import datetime
import eventlet

eventlet.monkey_patch()

app = Flask(__name__, static_folder='.', static_url_path='')
app.config['SECRET_KEY'] = 'your-secret-key-change-this-in-production'
CORS(app)
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='eventlet', ping_timeout=60, ping_interval=25)

# Routes coordinates from KML file
route_points = {
    '10k': [
        [22.37538, 114.18007],
        [22.37535, 114.18009],
        [22.37504, 114.18031],
        [22.37499, 114.18034],
        [22.37489, 114.18041],
        [22.37488, 114.18041],
        [22.37481, 114.18046],
        [22.37475, 114.1805],
        [22.37466, 114.18054],
        [22.37457, 114.18059],
        [22.37451, 114.18064],
        [22.3744, 114.18072],
        [22.37437, 114.18075],
        [22.3745, 114.18093],
        [22.37468, 114.18116],
        [22.37466, 114.18121],
        [22.37464, 114.18125],
        [22.37463, 114.1813],
        [22.3746, 114.18149],
        [22.37458, 114.1816],
        [22.37458, 114.18167],
        [22.37459, 114.18175],
        [22.3746, 114.18184],
        [22.37461, 114.18192],
        [22.37466, 114.18204],
        [22.3747, 114.18211],
        [22.3748, 114.18226],
        [22.37488, 114.18238],
        [22.37496, 114.18248],
        [22.37507, 114.18259],
        [22.37518, 114.18273],
        [22.37523, 114.1828],
        [22.37527, 114.18288],
        [22.3753, 114.18292],
        [22.37539, 114.18306],
        [22.37545, 114.18316],
        [22.37551, 114.18328],
        [22.37557, 114.1834],
        [22.37565, 114.18358],
        [22.37576, 114.18382],
        [22.37576, 114.18383],
        [22.37593, 114.18422],
        [22.37599, 114.18437],
        [22.3761, 114.18465],
        [22.37631, 114.18519],
        [22.37634, 114.18526],
        [22.37637, 114.18535],
        [22.3764, 114.18539],
        [22.37642, 114.18543],
        [22.37647, 114.18553],
        [22.37649, 114.18557],
        [22.37654, 114.18571],
        [22.37654, 114.18572],
        [22.37654, 114.18573],
        [22.37656, 114.18577],
        [22.37663, 114.18593],
        [22.37666, 114.18601],
        [22.3767, 114.18608],
        [22.37673, 114.18617],
        [22.37676, 114.18624],
        [22.37679, 114.1863],
        [22.3768, 114.18631],
        [22.37682, 114.18633],
        [22.37686, 114.18632],
        [22.37689, 114.1863],
        [22.37692, 114.18629],
        [22.37694, 114.18629],
        [22.37696, 114.18628],
        [22.37707, 114.18628],
        [22.37712, 114.18628],
        [22.37715, 114.18628],
        [22.37718, 114.18628],
        [22.37719, 114.18628],
        [22.3772, 114.18628],
        [22.37722, 114.18629],
        [22.37723, 114.1863],
        [22.37725, 114.18631],
        [22.37725, 114.18632],
        [22.37726, 114.18634],
        [22.37727, 114.18636],
        [22.37727, 114.18639],
        [22.37727, 114.18641],
        [22.3773, 114.18658],
        [22.37732, 114.18667],
        [22.37732, 114.18671],
        [22.37733, 114.18676],
        [22.37732, 114.18678],
        [22.37732, 114.1868],
        [22.37731, 114.18683],
        [22.37729, 114.18688],
        [22.37726, 114.18696],
        [22.37722, 114.18706],
        [22.37722, 114.18708],
        [22.3772, 114.18714],
        [22.37719, 114.18717],
        [22.3772, 114.18721],
        [22.3772, 114.18723],
        [22.37721, 114.18728],
        [22.37723, 114.18733],
        [22.37724, 114.18739],
        [22.37727, 114.18746],
        [22.37729, 114.18752],
        [22.37733, 114.18761],
        [22.37757, 114.18818],
        [22.37765, 114.18832],
        [22.37765, 114.18833],
        [22.3777, 114.18841],
        [22.37774, 114.18849],
        [22.37779, 114.18857],
        [22.37785, 114.18867],
        [22.37791, 114.18876],
        [22.37799, 114.18887],
        [22.37815, 114.18903],
        [22.37816, 114.18904],
        [22.37822, 114.1891],
        [22.37826, 114.18915],
        [22.37833, 114.18924],
        [22.37833, 114.18925],
        [22.37837, 114.18929],
        [22.37846, 114.18939],
        [22.37847, 114.1894],
        [22.3786, 114.18951],
        [22.37872, 114.18962],
        [22.37885, 114.18974],
        [22.37894, 114.18983],
        [22.37901, 114.1899],
        [22.37913, 114.19001],
        [22.37914, 114.19002],
        [22.37924, 114.19011],
        [22.37942, 114.19029],
        [22.37955, 114.19041],
        [22.37962, 114.19048],
        [22.37971, 114.19056],
        [22.37983, 114.19067],
        [22.38009, 114.19093],
        [22.38022, 114.19105],
        [22.38036, 114.19117],
        [22.38046, 114.19127],
        [22.38055, 114.19136],
        [22.38067, 114.19146],
        [22.38078, 114.19156],
        [22.38082, 114.1916],
        [22.38097, 114.19174],
        [22.38124, 114.192],
        [22.38146, 114.1922],
        [22.38152, 114.19226],
        [22.38159, 114.19233],
        [22.38173, 114.19246],
        [22.38174, 114.19247],
        [22.38192, 114.19265],
        [22.38195, 114.19268],
        [22.382, 114.19273],
        [22.38205, 114.19278],
        [22.38219, 114.19291],
        [22.38229, 114.193],
        [22.38265, 114.19335],
        [22.38296, 114.19365],
        [22.38378, 114.19444],
        [22.38385, 114.1945],
        [22.38395, 114.19459],
        [22.38449, 114.19509],
        [22.38451, 114.19511],
        [22.38484, 114.19542],
        [22.38491, 114.19549],
        [22.3853, 114.19586],
        [22.38545, 114.196],
        [22.38549, 114.19603],
        [22.38609, 114.19661],
        [22.38625, 114.19674],
        [22.3863, 114.1968],
        [22.38636, 114.19685],
        [22.38645, 114.19692],
        [22.38651, 114.19696],
        [22.38676, 114.19719],
        [22.38696, 114.19738],
        [22.38698, 114.1974],
        [22.38703, 114.19744],
        [22.3875, 114.19789],
        [22.38754, 114.19793],
        [22.3879, 114.19826],
        [22.38811, 114.19845],
        [22.38817, 114.19851],
        [22.38824, 114.19858],
        [22.38833, 114.19866],
        [22.38847, 114.1988],
        [22.38851, 114.19884],
        [22.38862, 114.19894],
        [22.38871, 114.19903],
        [22.38874, 114.19906],
        [22.38884, 114.19915],
        [22.38885, 114.19916],
        [22.38892, 114.19923],
        [22.38896, 114.19926],
        [22.389, 114.19929],
        [22.38904, 114.19932],
        [22.38911, 114.19936],
        [22.38913, 114.19938],
        [22.38915, 114.1994],
        [22.38922, 114.19946],
        [22.38925, 114.19949],
        [22.38927, 114.19951],
        [22.38929, 114.19955],
        [22.38932, 114.19959],
        [22.38933, 114.19961],
        [22.38934, 114.19962],
        [22.38938, 114.19964],
        [22.38942, 114.19965],
        [22.38945, 114.19967],
        [22.38946, 114.19967],
        [22.38947, 114.19968],
        [22.3895, 114.19973],
        [22.38953, 114.19979],
        [22.38954, 114.19981],
        [22.38957, 114.19984],
        [22.38958, 114.19985],
        [22.3896, 114.19987],
        [22.38975, 114.20002],
        [22.38977, 114.20004],
        [22.3899, 114.20016],
        [22.38991, 114.20016],
        [22.38993, 114.20019],
        [22.38996, 114.20021],
        [22.39002, 114.20024],
        [22.39005, 114.20026],
        [22.39011, 114.20029],
        [22.39018, 114.20032],
        [22.39024, 114.20034],
        [22.39035, 114.20040],
        [22.39038, 114.20041],
        [22.39041, 114.20043],
        [22.39045, 114.20047],
        [22.3906, 114.20061],
        [22.39067, 114.20067],
        [22.39076, 114.20076],
        [22.3908, 114.20079],
        [22.39085, 114.20081],
        [22.39089, 114.20082],
        [22.39093, 114.20083],
        [22.39097, 114.20084],
        [22.39101, 114.20086],
        [22.39106, 114.20088],
        [22.39118, 114.201],
        [22.39122, 114.20105],
        [22.39131, 114.20113],
        [22.39136, 114.20117],
        [22.39137, 114.20125],
        [22.39137, 114.20135],
        [22.39138, 114.20137],
        [22.39138, 114.20141],
        [22.39138, 114.20143],
        [22.39139, 114.20145],
        [22.39141, 114.20147],
        [22.39145, 114.20153],
        [22.39152, 114.2016],
        [22.39183, 114.20188],
        [22.39234, 114.20238],
        [22.39289, 114.20289],
        [22.39294, 114.20294],
        [22.39303, 114.20302],
        [22.39362, 114.20358],
        [22.39376, 114.20372],
        [22.39792, 114.20772],
        [22.40075, 114.21043],
        [22.4025, 114.21211],
        [22.40263, 114.21224],
        [22.40269, 114.21229],
        [22.40277, 114.21236],
        [22.4029, 114.21249],
        [22.40292, 114.21252],
        [22.40313, 114.21272],
        [22.40315, 114.21274],
        [22.40317, 114.21275],
        [22.40319, 114.21275],
        [22.40323, 114.21276],
        [22.40326, 114.21275],
        [22.40327, 114.21274],
        [22.40329, 114.21273],
        [22.40333, 114.21268],
        [22.40339, 114.21261],
        [22.4034, 114.2126],
        [22.40341, 114.2126],
        [22.40342, 114.2126],
        [22.40347, 114.21261],
        [22.40334, 114.21276],
        [22.4031, 114.21305],
        [22.40281, 114.2134],
        [22.40202, 114.21436],
        [22.40199, 114.21441],
        [22.40192, 114.21435],
        [22.40189, 114.21432],
        [22.40186, 114.21429],
        [22.40183, 114.21425],
        [22.40173, 114.21412],
        [22.40166, 114.21403],
        [22.40157, 114.21392],
        [22.40152, 114.21387],
        [22.40138, 114.21374],
        [22.40113, 114.2135],
        [22.40059, 114.21297],
        [22.40018, 114.21257],
        [22.40007, 114.21247],
        [22.39991, 114.21231],
        [22.39978, 114.21218],
        [22.39964, 114.21205],
        [22.39951, 114.21192],
        [22.39949, 114.21191],
        [22.39904, 114.21147],
        [22.39897, 114.21141],
        [22.39889, 114.21134],
        [22.3987, 114.21123],
        [22.39816, 114.21091],
        [22.39773, 114.21064],
        [22.39729, 114.2104],
        [22.39711, 114.2103],
        [22.39699, 114.21024],
        [22.39681, 114.21016],
        [22.39663, 114.21007],
        [22.39649, 114.21001],
        [22.39625, 114.20992],
        [22.39625, 114.20989],
        [22.39629, 114.20983],
        [22.39658, 114.20951],
        [22.3966, 114.20949],
        [22.39662, 114.20945],
        [22.39664, 114.20939],
        [22.39665, 114.20934],
        [22.39665, 114.20928],
        [22.39665, 114.20924],
        [22.39664, 114.20921],
        [22.39663, 114.20917],
        [22.3966, 114.20913],
        [22.39658, 114.20910],
        [22.39651, 114.20902],
        [22.39648, 114.20899],
        [22.3963, 114.20882],
        [22.39602, 114.20855],
        [22.39583, 114.20836],
        [22.39532, 114.20787],
        [22.39514, 114.2077],
        [22.39503, 114.20759],
        [22.39494, 114.20751],
        [22.39436, 114.20695],
        [22.39431, 114.2069],
        [22.39416, 114.20676],
        [22.39392, 114.20651],
        [22.39364, 114.20624],
        [22.39357, 114.20618],
        [22.39338, 114.20599],
        [22.39315, 114.20577],
        [22.39277, 114.2054],
        [22.3924, 114.20506],
        [22.39192, 114.20459],
        [22.39163, 114.2043],
        [22.3915, 114.20419],
        [22.39142, 114.20415],
        [22.39134, 114.20413],
        [22.39116, 114.20410],
        [22.39096, 114.20408],
        [22.39066, 114.20408],
        [22.39065, 114.20418],
        [22.39054, 114.20424],
        [22.39046, 114.2043],
        [22.39035, 114.20443],
        [22.39033, 114.20447],
        [22.39034, 114.20451],
        [22.39034, 114.20453],
        [22.39034, 114.20456],
        [22.39028, 114.20459],
        [22.39024, 114.2046],
        [22.3902, 114.20459],
        [22.39016, 114.20457],
        [22.39014, 114.20455],
        [22.39011, 114.20452],
        [22.39008, 114.20451],
        [22.39006, 114.2045],
        [22.39004, 114.2045],
        [22.39003, 114.20449],
        [22.39001, 114.20445],
        [22.39, 114.20443],
        [22.38996, 114.20437],
        [22.38991, 114.20427],
        [22.38983, 114.20414],
        [22.38981, 114.20411],
        [22.38973, 114.20398],
        [22.3897, 114.20393],
        [22.38959, 114.20368],
        [22.38956, 114.2036],
        [22.38953, 114.20352],
        [22.38952, 114.20345],
        [22.38952, 114.20341],
        [22.38951, 114.20337],
        [22.38944, 114.20307],
        [22.38941, 114.20299],
        [22.38937, 114.20289],
        [22.38933, 114.20278],
        [22.38932, 114.20276],
        [22.38931, 114.20265],
        [22.38932, 114.20261],
        [22.38932, 114.20259],
        [22.38932, 114.20258],
        [22.38932, 114.20256],
        [22.3893, 114.20253],
        [22.38926, 114.20246],
        [22.38923, 114.2024],
        [22.38923, 114.20239],
        [22.3892, 114.20233],
        [22.38918, 114.20227],
        [22.38908, 114.20204],
        [22.389, 114.2019],
        [22.38888, 114.20174],
        [22.38868, 114.20151],
        [22.38865, 114.20149],
        [22.38864, 114.20148],
        [22.38862, 114.20146],
        [22.3885, 114.20136],
        [22.38838, 114.20125],
        [22.38836, 114.20124],
        [22.38822, 114.20112],
        [22.38815, 114.20107],
        [22.38808, 114.201],
        [22.38799, 114.2009],
        [22.38794, 114.20084],
        [22.3878, 114.20071],
        [22.38778, 114.20069],
        [22.38775, 114.20067],
        [22.38767, 114.20059],
        [22.38759, 114.20052],
        [22.38756, 114.2005],
        [22.38751, 114.20045],
        [22.38737, 114.20033],
        [22.38733, 114.2003],
        [22.38729, 114.20026],
        [22.38728, 114.20024],
        [22.38728, 114.20023],
        [22.38727, 114.20018],
        [22.38727, 114.20017],
        [22.38726, 114.20013],
        [22.38726, 114.20011],
        [22.38725, 114.2001],
        [22.38724, 114.20007],
        [22.38723, 114.20006],
        [22.38721, 114.20003],
        [22.38706, 114.19989],
        [22.38703, 114.19986],
        [22.38674, 114.19958],
        [22.38662, 114.19946],
        [22.38658, 114.19942],
        [22.38647, 114.19932],
        [22.38639, 114.19926],
        [22.38636, 114.19923],
        [22.38632, 114.19922],
        [22.38627, 114.19919],
        [22.38616, 114.19912],
        [22.38608, 114.19905],
        [22.38598, 114.19897],
        [22.38596, 114.19894],
        [22.38593, 114.19892],
        [22.3859, 114.19886],
        [22.38584, 114.19878],
        [22.38579, 114.19871],
        [22.3857, 114.19861],
        [22.38563, 114.19854],
        [22.38528, 114.1982],
        [22.38515, 114.19808],
        [22.38504, 114.19797],
        [22.3849, 114.19784],
        [22.38482, 114.19777],
        [22.38473, 114.19769],
        [22.38458, 114.19757],
        [22.3845, 114.19751],
        [22.38444, 114.19744],
        [22.38439, 114.19739],
        [22.38428, 114.19729],
        [22.38427, 114.19728],
        [22.38414, 114.19714],
        [22.38407, 114.19708],
        [22.384, 114.19701],
        [22.38353, 114.19658],
        [22.38346, 114.1965],
        [22.38337, 114.19641],
        [22.38332, 114.19636],
        [22.38328, 114.19633],
        [22.38326, 114.1963],
        [22.38324, 114.19627],
        [22.38318, 114.19619],
        [22.38314, 114.19614],
        [22.38311, 114.19609],
        [22.38298, 114.19593],
        [22.38295, 114.1959],
        [22.38117, 114.19417],
        [22.38104, 114.19404],
        [22.3809, 114.19391],
        [22.38083, 114.19382],
        [22.3805, 114.19352],
        [22.38039, 114.19339],
        [22.38021, 114.19321],
        [22.3797, 114.19273],
        [22.37963, 114.19266],
        [22.37948, 114.19251],
        [22.3793, 114.19234],
        [22.37919, 114.19223],
        [22.37917, 114.19221],
        [22.37908, 114.19212],
        [22.37904, 114.19208],
        [22.37891, 114.19194],
        [22.37882, 114.19185],
        [22.37874, 114.19179],
        [22.37868, 114.19173],
        [22.37818, 114.19128],
        [22.37815, 114.19125],
        [22.37812, 114.19122],
        [22.37809, 114.1912],
        [22.37807, 114.19118],
        [22.37802, 114.19113],
        [22.37798, 114.19109],
        [22.37797, 114.19106],
        [22.37796, 114.19103],
        [22.37795, 114.19102],
        [22.37791, 114.19096],
        [22.37785, 114.19086],
        [22.37778, 114.19076],
        [22.37771, 114.19066],
        [22.37762, 114.19053],
        [22.37752, 114.19033],
        [22.37747, 114.19023],
        [22.37743, 114.19016],
        [22.37731, 114.18986],
        [22.37726, 114.18976],
        [22.37725, 114.18972],
        [22.37714, 114.18947],
        [22.37707, 114.18931],
        [22.37704, 114.18923],
        [22.37701, 114.18916],
        [22.37694, 114.189],
        [22.37687, 114.18883],
        [22.37678, 114.1886],
        [22.37678, 114.18859],
        [22.37678, 114.18858],
        [22.37678, 114.18857],
        [22.37679, 114.18856],
        [22.37627, 114.18733],
        [22.37623, 114.18737],
        [22.37622, 114.18739],
        [22.37619, 114.18751],
        [22.37617, 114.18753],
        [22.37616, 114.18754],
        [22.37615, 114.18755],
        [22.37613, 114.18756],
        [22.37612, 114.18758],
        [22.37611, 114.18759],
        [22.37609, 114.18762],
        [22.37607, 114.18766],
        [22.37605, 114.18769],
        [22.37603, 114.18774],
        [22.376, 114.18779],
        [22.37598, 114.18784],
        [22.37597, 114.18786],
        [22.37595, 114.18788],
        [22.37594, 114.18789],
        [22.37592, 114.1879],
        [22.3759, 114.1879],
        [22.37588, 114.18791],
        [22.37584, 114.18791],
        [22.3758, 114.18791],
        [22.37578, 114.18786],
        [22.37565, 114.18768],
        [22.37562, 114.18763],
        [22.37551, 114.18747],
        [22.37549, 114.18742],
        [22.37548, 114.18739],
        [22.37547, 114.18736],
        [22.37547, 114.18732],
        [22.37546, 114.1873],
        [22.37547, 114.18727],
        [22.37547, 114.18723],
        [22.37548, 114.18721],
        [22.37548, 114.18717],
        [22.37549, 114.18715],
        [22.37551, 114.18712],
        [22.37552, 114.1871],
        [22.37554, 114.18707],
        [22.37557, 114.18704],
        [22.37559, 114.18702],
        [22.37562, 114.187],
        [22.37567, 114.18697],
        [22.37568, 114.18696],
        [22.37571, 114.18694],
        [22.37576, 114.18691],
        [22.37588, 114.18684],
        [22.376, 114.18678],
        [22.37597, 114.18671],
        [22.37583, 114.18637],
        [22.37556, 114.18572],
        [22.37549, 114.18554],
        [22.37541, 114.18533],
        [22.37531, 114.1851],
        [22.37526, 114.18496],
        [22.37524, 114.1849],
        [22.37523, 114.18486],
        [22.37518, 114.18476],
        [22.37511, 114.18461],
        [22.37504, 114.18441],
        [22.37502, 114.18437],
        [22.375, 114.18429],
        [22.37496, 114.18419],
        [22.3748, 114.18386],
        [22.37477, 114.18382],
        [22.37469, 114.18373],
        [22.37461, 114.1836],
        [22.37458, 114.18357],
        [22.37456, 114.18353],
        [22.37454, 114.18347],
        [22.3745, 114.18338],
        [22.37449, 114.18333],
        [22.37445, 114.18324],
        [22.37439, 114.18314],
        [22.37435, 114.18306],
        [22.37429, 114.18295],
        [22.37423, 114.18286],
        [22.37399, 114.18247],
        [22.37395, 114.1824],
        [22.37393, 114.18236],
        [22.37391, 114.18233],
        [22.37389, 114.18228],
        [22.37386, 114.18216],
        [22.37385, 114.18211],
        [22.37384, 114.18205],
        [22.37384, 114.18196],
        [22.37383, 114.18186],
        [22.37383, 114.18177],
        [22.37384, 114.18169],
        [22.37385, 114.18161],
        [22.37386, 114.18153],
        [22.37388, 114.18145],
        [22.3739, 114.18138],
        [22.37391, 114.18136],
        [22.37392, 114.18131],
        [22.37396, 114.18124],
        [22.374, 114.18116],
        [22.37404, 114.18109],
        [22.37409, 114.18102],
        [22.37418, 114.1809],
        [22.37424, 114.18085],
        [22.3743, 114.1808],
        [22.37437, 114.18075],
        [22.3744, 114.18072],
        [22.37451, 114.18064],
        [22.37457, 114.18059],
        [22.37466, 114.18054],
        [22.37475, 114.1805],
        [22.37481, 114.18046],
        [22.37488, 114.18041],
        [22.37489, 114.18041],
        [22.37499, 114.18034],
        [22.37504, 114.18031],
        [22.37535, 114.18009],
        [22.37538, 114.18007]
    ],
    '5k': [
        [22.37538, 114.18007],
        [22.37535, 114.18009],
        [22.37504, 114.18031],
        [22.37499, 114.18034],
        [22.37489, 114.18041],
        [22.37488, 114.18041],
        [22.37481, 114.18046],
        [22.37475, 114.1805],
        [22.37466, 114.18054],
        [22.37457, 114.18059],
        [22.37451, 114.18064],
        [22.3744, 114.18072],
        [22.37437, 114.18075],
        [22.3745, 114.18093],
        [22.37468, 114.18116],
        [22.37466, 114.18121],
        [22.37464, 114.18125],
        [22.37463, 114.1813],
        [22.3746, 114.18149],
        [22.37458, 114.1816],
        [22.37458, 114.18167],
        [22.37459, 114.18175],
        [22.3746, 114.18184],
        [22.37461, 114.18192],
        [22.37466, 114.18204],
        [22.3747, 114.18211],
        [22.3748, 114.18226],
        [22.37488, 114.18238],
        [22.37496, 114.18248],
        [22.37507, 114.18259],
        [22.37518, 114.18273],
        [22.37523, 114.1828],
        [22.37527, 114.18288],
        [22.3753, 114.18292],
        [22.37539, 114.18306],
        [22.37545, 114.18316],
        [22.37551, 114.18328],
        [22.37557, 114.1834],
        [22.37565, 114.18358],
        [22.37576, 114.18382],
        [22.37576, 114.18383],
        [22.37593, 114.18422],
        [22.37599, 114.18437],
        [22.3761, 114.18465],
        [22.37631, 114.18519],
        [22.37634, 114.18526],
        [22.37637, 114.18535],
        [22.3764, 114.18539],
        [22.37642, 114.18543],
        [22.37647, 114.18553],
        [22.37649, 114.18557],
        [22.37654, 114.18571],
        [22.37654, 114.18572],
        [22.37654, 114.18573],
        [22.37656, 114.18577],
        [22.37663, 114.18593],
        [22.37666, 114.18601],
        [22.3767, 114.18608],
        [22.37673, 114.18617],
        [22.37676, 114.18624],
        [22.37679, 114.1863],
        [22.3768, 114.18631],
        [22.37682, 114.18633],
        [22.37686, 114.18632],
        [22.37689, 114.1863],
        [22.37692, 114.18629],
        [22.37694, 114.18629],
        [22.37696, 114.18628],
        [22.37707, 114.18628],
        [22.37712, 114.18628],
        [22.37715, 114.18628],
        [22.37718, 114.18628],
        [22.37719, 114.18628],
        [22.3772, 114.18628],
        [22.37722, 114.18629],
        [22.37723, 114.1863],
        [22.37725, 114.18631],
        [22.37725, 114.18632],
        [22.37726, 114.18634],
        [22.37727, 114.18636],
        [22.37727, 114.18639],
        [22.37727, 114.18641],
        [22.3773, 114.18658],
        [22.37732, 114.18667],
        [22.37732, 114.18671],
        [22.37733, 114.18676],
        [22.37732, 114.18678],
        [22.37732, 114.1868],
        [22.37731, 114.18683],
        [22.37729, 114.18688],
        [22.37726, 114.18696],
        [22.37722, 114.18706],
        [22.37722, 114.18708],
        [22.3772, 114.18714],
        [22.37719, 114.18717],
        [22.3772, 114.18721],
        [22.3772, 114.18723],
        [22.37721, 114.18728],
        [22.37723, 114.18733],
        [22.37724, 114.18739],
        [22.37727, 114.18746],
        [22.37729, 114.18752],
        [22.37733, 114.18761],
        [22.37757, 114.18818],
        [22.37765, 114.18832],
        [22.37765, 114.18833],
        [22.3777, 114.18841],
        [22.37774, 114.18849],
        [22.37779, 114.18857],
        [22.37785, 114.18867],
        [22.37791, 114.18876],
        [22.37799, 114.18887],
        [22.37815, 114.18903],
        [22.37816, 114.18904],
        [22.37822, 114.1891],
        [22.37826, 114.18915],
        [22.37833, 114.18924],
        [22.37833, 114.18925],
        [22.37837, 114.18929],
        [22.37846, 114.18939],
        [22.37847, 114.1894],
        [22.3786, 114.18951],
        [22.37872, 114.18962],
        [22.37885, 114.18974],
        [22.37894, 114.18983],
        [22.37901, 114.1899],
        [22.37913, 114.19001],
        [22.37914, 114.19002],
        [22.37924, 114.19011],
        [22.37942, 114.19029],
        [22.37955, 114.19041],
        [22.37962, 114.19048],
        [22.37971, 114.19056],
        [22.37983, 114.19067],
        [22.38009, 114.19093],
        [22.38022, 114.19105],
        [22.38036, 114.19117],
        [22.38046, 114.19127],
        [22.38055, 114.19136],
        [22.38067, 114.19146],
        [22.38078, 114.19156],
        [22.38082, 114.1916],
        [22.38097, 114.19174],
        [22.38124, 114.192],
        [22.38146, 114.1922],
        [22.38152, 114.19226],
        [22.38159, 114.19233],
        [22.38173, 114.19246],
        [22.38174, 114.19247],
        [22.38192, 114.19265],
        [22.38195, 114.19268],
        [22.382, 114.19273],
        [22.38205, 114.19278],
        [22.38219, 114.19291],
        [22.38229, 114.193],
        [22.38265, 114.19335],
        [22.38296, 114.19365],
        [22.38378, 114.19444],
        [22.38385, 114.1945],
        [22.38395, 114.19459],
        [22.38449, 114.19509],
        [22.38451, 114.19511],
        [22.38484, 114.19542],
        [22.38491, 114.19549],
        [22.3853, 114.19586],
        [22.38545, 114.196],
        [22.38549, 114.19603],
        [22.38609, 114.19661],
        [22.38625, 114.19674],
        [22.3863, 114.1968],
        [22.38636, 114.19685],
        [22.38645, 114.19692],
        [22.38651, 114.19696],
        [22.38676, 114.19719],
        [22.38696, 114.19738],
        [22.38698, 114.1974],
        [22.38703, 114.19744],
        [22.3875, 114.19789],
        [22.38754, 114.19793],
        [22.3879, 114.19826],
        [22.38811, 114.19845],
        [22.38813, 114.19843],
        [22.38815, 114.19840],
        [22.38817, 114.19838],
        [22.38818, 114.19836],
        [22.38820, 114.19835],
        [22.38822, 114.19834],
        [22.38824, 114.19833],
        [22.38825, 114.19833],
        [22.38827, 114.19833],
        [22.38829, 114.19834],
        [22.38830, 114.19835],
        [22.38831, 114.19836],
        [22.38833, 114.19838],
        [22.38838, 114.19843],
        [22.38837, 114.19845],
        [22.38836, 114.19847],
        [22.38834, 114.19851],
        [22.38832, 114.19854],
        [22.38831, 114.19857],
        [22.38829, 114.19859],
        [22.38824, 114.19864],
        [22.38807, 114.19885],
        [22.38799, 114.19894],
        [22.38777, 114.1992],
        [22.38772, 114.19927],
        [22.38764, 114.19936],
        [22.38758, 114.19943],
        [22.38752, 114.19950],
        [22.38742, 114.19961],
        [22.38718, 114.19991],
        [22.38716, 114.19993],
        [22.38712, 114.19997],
        [22.38710, 114.19997],
        [22.38708, 114.19997],
        [22.38707, 114.19998],
        [22.38705, 114.19998],
        [22.38702, 114.19997],
        [22.38700, 114.19995],
        [22.38694, 114.19989],
        [22.38690, 114.19986],
        [22.38683, 114.19976],
        [22.38675, 114.19964],
        [22.38674, 114.19958],
        [22.38662, 114.19946],
        [22.38658, 114.19942],
        [22.38647, 114.19932],
        [22.38639, 114.19926],
        [22.38636, 114.19923],
        [22.38632, 114.19922],
        [22.38627, 114.19919],
        [22.38616, 114.19912],
        [22.38608, 114.19905],
        [22.38598, 114.19897],
        [22.38596, 114.19894],
        [22.38593, 114.19892],
        [22.3859, 114.19886],
        [22.38584, 114.19878],
        [22.38579, 114.19871],
        [22.3857, 114.19861],
        [22.38563, 114.19854],
        [22.38528, 114.1982],
        [22.38515, 114.19808],
        [22.38504, 114.19797],
        [22.3849, 114.19784],
        [22.38482, 114.19777],
        [22.38473, 114.19769],
        [22.38458, 114.19757],
        [22.3845, 114.19751],
        [22.38444, 114.19744],
        [22.38439, 114.19739],
        [22.38428, 114.19729],
        [22.38427, 114.19728],
        [22.38414, 114.19714],
        [22.38407, 114.19708],
        [22.384, 114.19701],
        [22.38353, 114.19658],
        [22.38346, 114.1965],
        [22.38337, 114.19641],
        [22.38332, 114.19636],
        [22.38328, 114.19633],
        [22.38326, 114.1963],
        [22.38324, 114.19627],
        [22.38318, 114.19619],
        [22.38314, 114.19614],
        [22.38311, 114.19609],
        [22.38298, 114.19593],
        [22.38295, 114.1959],
        [22.38117, 114.19417],
        [22.38104, 114.19404],
        [22.3809, 114.19391],
        [22.38083, 114.19382],
        [22.3805, 114.19352],
        [22.38039, 114.19339],
        [22.38021, 114.19321],
        [22.3797, 114.19273],
        [22.37963, 114.19266],
        [22.37948, 114.19251],
        [22.3793, 114.19234],
        [22.37919, 114.19223],
        [22.37917, 114.19221],
        [22.37908, 114.19212],
        [22.37904, 114.19208],
        [22.37891, 114.19194],
        [22.37882, 114.19185],
        [22.37874, 114.19179],
        [22.37868, 114.19173],
        [22.37818, 114.19128],
        [22.37815, 114.19125],
        [22.37812, 114.19122],
        [22.37809, 114.1912],
        [22.37807, 114.19118],
        [22.37802, 114.19113],
        [22.37798, 114.19109],
        [22.37797, 114.19106],
        [22.37796, 114.19103],
        [22.37795, 114.19102],
        [22.37791, 114.19096],
        [22.37785, 114.19086],
        [22.37778, 114.19076],
        [22.37771, 114.19066],
        [22.37762, 114.19053],
        [22.37752, 114.19033],
        [22.37747, 114.19023],
        [22.37743, 114.19016],
        [22.37731, 114.18986],
        [22.37726, 114.18976],
        [22.37725, 114.18972],
        [22.37714, 114.18947],
        [22.37707, 114.18931],
        [22.37704, 114.18923],
        [22.37701, 114.18916],
        [22.37694, 114.189],
        [22.37687, 114.18883],
        [22.37678, 114.1886],
        [22.37678, 114.18859],
        [22.37678, 114.18858],
        [22.37678, 114.18857],
        [22.37679, 114.18856],
        [22.37627, 114.18733],
        [22.37623, 114.18737],
        [22.37622, 114.18739],
        [22.37619, 114.18751],
        [22.37617, 114.18753],
        [22.37616, 114.18754],
        [22.37615, 114.18755],
        [22.37613, 114.18756],
        [22.37612, 114.18758],
        [22.37611, 114.18759],
        [22.37609, 114.18762],
        [22.37607, 114.18766],
        [22.37605, 114.18769],
        [22.37603, 114.18774],
        [22.376, 114.18779],
        [22.37598, 114.18784],
        [22.37597, 114.18786],
        [22.37595, 114.18788],
        [22.37594, 114.18789],
        [22.37592, 114.1879],
        [22.3759, 114.1879],
        [22.37588, 114.18791],
        [22.37584, 114.18791],
        [22.3758, 114.18791],
        [22.37578, 114.18786],
        [22.37565, 114.18768],
        [22.37562, 114.18763],
        [22.37551, 114.18747],
        [22.37549, 114.18742],
        [22.37548, 114.18739],
        [22.37547, 114.18736],
        [22.37547, 114.18732],
        [22.37546, 114.1873],
        [22.37547, 114.18727],
        [22.37547, 114.18723],
        [22.37548, 114.18721],
        [22.37548, 114.18717],
        [22.37549, 114.18715],
        [22.37551, 114.18712],
        [22.37552, 114.1871],
        [22.37554, 114.18707],
        [22.37557, 114.18704],
        [22.37559, 114.18702],
        [22.37562, 114.187],
        [22.37567, 114.18697],
        [22.37568, 114.18696],
        [22.37571, 114.18694],
        [22.37576, 114.18691],
        [22.37588, 114.18684],
        [22.376, 114.18678],
        [22.37597, 114.18671],
        [22.37583, 114.18637],
        [22.37556, 114.18572],
        [22.37549, 114.18554],
        [22.37541, 114.18533],
        [22.37531, 114.1851],
        [22.37526, 114.18496],
        [22.37524, 114.1849],
        [22.37523, 114.18486],
        [22.37518, 114.18476],
        [22.37511, 114.18461],
        [22.37504, 114.18441],
        [22.37502, 114.18437],
        [22.375, 114.18429],
        [22.37496, 114.18419],
        [22.3748, 114.18386],
        [22.37477, 114.18382],
        [22.37469, 114.18373],
        [22.37461, 114.1836],
        [22.37458, 114.18357],
        [22.37456, 114.18353],
        [22.37454, 114.18347],
        [22.3745, 114.18338],
        [22.37449, 114.18333],
        [22.37445, 114.18324],
        [22.37439, 114.18314],
        [22.37435, 114.18306],
        [22.37429, 114.18295],
        [22.37423, 114.18286],
        [22.37399, 114.18247],
        [22.37395, 114.1824],
        [22.37393, 114.18236],
        [22.37391, 114.18233],
        [22.37389, 114.18228],
        [22.37386, 114.18216],
        [22.37385, 114.18211],
        [22.37384, 114.18205],
        [22.37384, 114.18196],
        [22.37383, 114.18186],
        [22.37383, 114.18177],
        [22.37384, 114.18169],
        [22.37385, 114.18161],
        [22.37386, 114.18153],
        [22.37388, 114.18145],
        [22.3739, 114.18138],
        [22.37391, 114.18136],
        [22.37392, 114.18131],
        [22.37396, 114.18124],
        [22.374, 114.18116],
        [22.37404, 114.18109],
        [22.37409, 114.18102],
        [22.37418, 114.1809],
        [22.37424, 114.18085],
        [22.3743, 114.1808],
        [22.37437, 114.18075],
        [22.3744, 114.18072],
        [22.37451, 114.18064],
        [22.37457, 114.18059],
        [22.37466, 114.18054],
        [22.37475, 114.1805],
        [22.37481, 114.18046],
        [22.37488, 114.18041],
        [22.37489, 114.18041],
        [22.37499, 114.18034],
        [22.37504, 114.18031],
        [22.37535, 114.18009],
        [22.37538, 114.18007]
    ],
    '2k': [
        [22.37538, 114.18007],
        [22.37535, 114.18009],
        [22.37504, 114.18031],
        [22.37499, 114.18034],
        [22.37489, 114.18041],
        [22.37488, 114.18041],
        [22.37481, 114.18046],
        [22.37475, 114.1805],
        [22.37466, 114.18054],
        [22.37457, 114.18059],
        [22.37451, 114.18064],
        [22.3744, 114.18072],
        [22.37437, 114.18075],
        [22.3743, 114.1808],
        [22.37424, 114.18085],
        [22.37418, 114.1809],
        [22.37409, 114.18102],
        [22.37404, 114.18109],
        [22.374, 114.18116],
        [22.37396, 114.18124],
        [22.37392, 114.18131],
        [22.37391, 114.18136],
        [22.3739, 114.18138],
        [22.37388, 114.18145],
        [22.37386, 114.18153],
        [22.37385, 114.18161],
        [22.37384, 114.18169],
        [22.37383, 114.18177],
        [22.37383, 114.18186],
        [22.37384, 114.18196],
        [22.37384, 114.18205],
        [22.37385, 114.18211],
        [22.37386, 114.18216],
        [22.37389, 114.18228],
        [22.37391, 114.18233],
        [22.37393, 114.18236],
        [22.37395, 114.1824],
        [22.37399, 114.18247],
        [22.37423, 114.18286],
        [22.37429, 114.18295],
        [22.37435, 114.18306],
        [22.37439, 114.18314],
        [22.37445, 114.18324],
        [22.37449, 114.18333],
        [22.3745, 114.18338],
        [22.37454, 114.18347],
        [22.37456, 114.18353],
        [22.37458, 114.18357],
        [22.37461, 114.1836],
        [22.37469, 114.18373],
        [22.37477, 114.18382],
        [22.3748, 114.18386],
        [22.37496, 114.18419],
        [22.375, 114.18429],
        [22.37502, 114.18437],
        [22.37504, 114.18441],
        [22.37511, 114.18461],
        [22.37518, 114.18476],
        [22.37523, 114.18486],
        [22.37524, 114.1849],
        [22.37526, 114.18496],
        [22.37531, 114.1851],
        [22.37541, 114.18533],
        [22.37549, 114.18554],
        [22.37556, 114.18572],
        [22.37583, 114.18637],
        [22.37597, 114.18671],
        [22.376, 114.18678],
        [22.37588, 114.18684],
        [22.37576, 114.18691],
        [22.37571, 114.18694],
        [22.37568, 114.18696],
        [22.37567, 114.18697],
        [22.37562, 114.187],
        [22.37559, 114.18702],
        [22.37557, 114.18704],
        [22.37554, 114.18707],
        [22.37552, 114.1871],
        [22.37551, 114.18712],
        [22.37549, 114.18715],
        [22.37548, 114.18717],
        [22.37548, 114.18721],
        [22.37547, 114.18723],
        [22.37547, 114.18727],
        [22.37546, 114.1873],
        [22.37547, 114.18732],
        [22.37547, 114.18736],
        [22.37548, 114.18739],
        [22.37549, 114.18742],
        [22.37551, 114.18747],
        [22.37562, 114.18763],
        [22.37565, 114.18768],
        [22.37578, 114.18786],
        [22.3758, 114.18791],
        [22.37584, 114.18791],
        [22.37588, 114.18791],
        [22.3759, 114.1879],
        [22.37592, 114.1879],
        [22.37594, 114.18789],
        [22.37595, 114.18788],
        [22.37597, 114.18786],
        [22.37598, 114.18784],
        [22.376, 114.18779],
        [22.37603, 114.18774],
        [22.37605, 114.18769],
        [22.37607, 114.18766],
        [22.37609, 114.18762],
        [22.37611, 114.18759],
        [22.37612, 114.18758],
        [22.37613, 114.18756],
        [22.37615, 114.18755],
        [22.37616, 114.18754],
        [22.37618, 114.18752],
        [22.37619, 114.18750],
        [22.37623, 114.18738],
        [22.37625, 114.18735],
        [22.37627, 114.18733],
        [22.37663, 114.18817],
        [22.3768, 114.18856],
        [22.37757, 114.18818],
        [22.37733, 114.18761],
        [22.37729, 114.18752],
        [22.37727, 114.18746],
        [22.37724, 114.18739],
        [22.37723, 114.18733],
        [22.37721, 114.18728],
        [22.37721, 114.18727],
        [22.3772, 114.18723],
        [22.37719, 114.18720],
        [22.37719, 114.18717],
        [22.3772, 114.18714],
        [22.37722, 114.18708],
        [22.37722, 114.18706],
        [22.37726, 114.18696],
        [22.37729, 114.18688],
        [22.37731, 114.18683],
        [22.37732, 114.1868],
        [22.37732, 114.18678],
        [22.37733, 114.18676],
        [22.37732, 114.18671],
        [22.37732, 114.18667],
        [22.3773, 114.18658],
        [22.37727, 114.18641],
        [22.37727, 114.18639],
        [22.37727, 114.18636],
        [22.37726, 114.18634],
        [22.37725, 114.18632],
        [22.37725, 114.18631],
        [22.37723, 114.1863],
        [22.37722, 114.18629],
        [22.3772, 114.18628],
        [22.37719, 114.18628],
        [22.37718, 114.18628],
        [22.37715, 114.18628],
        [22.37712, 114.18628],
        [22.37707, 114.18628],
        [22.37696, 114.18628],
        [22.37694, 114.18629],
        [22.37692, 114.18629],
        [22.37689, 114.1863],
        [22.37686, 114.18632],
        [22.37682, 114.18633],
        [22.3768, 114.18631],
        [22.37679, 114.1863],
        [22.37676, 114.18624],
        [22.37673, 114.18617],
        [22.3767, 114.18608],
        [22.37666, 114.18601],
        [22.37663, 114.18593],
        [22.37656, 114.18577],
        [22.37654, 114.18573],
        [22.37654, 114.18572],
        [22.37654, 114.18571],
        [22.37649, 114.18557],
        [22.37647, 114.18553],
        [22.37642, 114.18543],
        [22.3764, 114.18539],
        [22.37637, 114.18535],
        [22.37634, 114.18526],
        [22.37631, 114.18519],
        [22.3761, 114.18465],
        [22.37599, 114.18437],
        [22.37593, 114.18422],
        [22.37576, 114.18383],
        [22.37576, 114.18382],
        [22.37565, 114.18358],
        [22.37557, 114.1834],
        [22.37551, 114.18328],
        [22.37545, 114.18316],
        [22.37539, 114.18306],
        [22.3753, 114.18292],
        [22.37527, 114.18288],
        [22.37523, 114.1828],
        [22.37518, 114.18273],
        [22.37507, 114.18259],
        [22.37496, 114.18248],
        [22.37488, 114.18238],
        [22.3748, 114.18226],
        [22.3747, 114.18211],
        [22.37466, 114.18204],
        [22.37461, 114.18192],
        [22.3746, 114.18184],
        [22.37459, 114.18175],
        [22.37458, 114.18167],
        [22.37458, 114.1816],
        [22.3746, 114.18149],
        [22.37463, 114.1813],
        [22.37464, 114.18125],
        [22.37466, 114.18121],
        [22.37468, 114.18116],
        [22.3745, 114.18093],
        [22.37437, 114.18075],
        [22.3744, 114.18072],
        [22.37451, 114.18064],
        [22.37457, 114.18059],
        [22.37466, 114.18054],
        [22.37475, 114.1805],
        [22.37481, 114.18046],
        [22.37488, 114.18041],
        [22.37489, 114.18041],
        [22.37499, 114.18034],
        [22.37504, 114.18031],
        [22.37535, 114.18009],
        [22.37538, 114.18007]
    ]
}

# In-memory storage
users = {}
crews = {}
emergencies = {}

@app.route('/')
def index():
    return app.send_static_file('index.html')

@app.route('/crew')
def crew():
    return app.send_static_file('crew.html')

@app.route('/api/routes/<route_name>')
def get_route(route_name):
    if route_name in route_points:
        return jsonify({'route': route_points[route_name]})
    return jsonify({'error': 'Route not found'}), 404

@app.route('/api/all-routes')
def get_all_routes():
    return jsonify(route_points)

@socketio.on('connect')
def handle_connect():
    print('Client connected:', request.sid)

@socketio.on('disconnect')
def handle_disconnect():
    sid = request.sid
    # Remove from users
    if sid in users:
        user_id = users[sid]['id']
        del users[sid]
        socketio.emit('user_left', {'id': user_id})
    
    # Remove from crews
    if sid in crews:
        crew_id = crews[sid]['id']
        del crews[sid]
        socketio.emit('crew_left', {'id': crew_id})
    
    print('Client disconnected:', sid)

@socketio.on('runner_location')
def handle_runner_location(data):
    sid = request.sid
    users[sid] = {
        'id': sid,
        'type': 'runner',
        'location': [data['lat'], data['lng']],
        'emergency': data.get('emergency', False),
        'timestamp': time.time()
    }
    
    # Broadcast to crews
    socketio.emit('runner_update', {
        'id': sid,
        'location': [data['lat'], data['lng']],
        'emergency': data.get('emergency', False)
    }, include_self=False)

@socketio.on('crew_location')
def handle_crew_location(data):
    sid = request.sid
    crews[sid] = {
        'id': sid,
        'type': 'crew',
        'location': [data['lat'], data['lng']],
        'transport': data.get('transport', 'walk'),
        'first_aid': data.get('first_aid', False),
        'sharing': data.get('sharing', True),
        'timestamp': time.time()
    }
    
    # Broadcast to all
    socketio.emit('crew_update', {
        'id': sid,
        'location': [data['lat'], data['lng']],
        'transport': data.get('transport', 'walk'),
        'first_aid': data.get('first_aid', False),
        'sharing': data.get('sharing', True)
    })

@socketio.on('emergency_request')
def handle_emergency(data):
    sid = request.sid
    emergencies[sid] = {
        'id': sid,
        'location': data['location'],
        'timestamp': time.time(),
        'status': 'active'
    }
    
    # Update user status
    if sid in users:
        users[sid]['emergency'] = True
    
    # Notify all crews
    socketio.emit('emergency_alert', {
        'id': sid,
        'location': data['location'],
        'timestamp': datetime.now().isoformat()
    }, include_self=False)

@socketio.on('emergency_resolved')
def handle_emergency_resolved(data):
    sid = data.get('id', request.sid)
    
    # Remove from emergencies
    if sid in emergencies:
        del emergencies[sid]
    
    # Update user status
    if sid in users:
        users[sid]['emergency'] = False
    
    # Notify all
    socketio.emit('emergency_resolved', {'id': sid})

@socketio.on('get_initial_data')
def handle_initial_data():
    sid = request.sid
    return {
        'users': {uid: users[uid] for uid in users},
        'crews': {cid: crews[cid] for cid in crews},
        'emergencies': emergencies
    }

if __name__ == '__main__':
    socketio.run(app, debug=True, port=5000)