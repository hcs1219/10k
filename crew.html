<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Tracker - Crew</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        #map { height: 60vh; }
        .runner-icon { background: #3B82F6; }
        .crew-walk { background: #F97316; }
        .crew-bike { background: #F59E0B; }
        .crew-aid { background: #DC2626; color: white; }
        .emergency-icon { background: #EF4444; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-2">
        <!-- Header -->
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold text-gray-900">Crew Dashboard</h1>
            <div class="flex items-center">
                <span id="connectionStatus" class="px-2 py-1">
                    <i class="fas fa-wifi text-gray-500"></i>
                </span>
            </div>
        </div>

        <!-- Crew Controls -->
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="bg-white p-2 rounded border border-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xs">Share Location</span>
                    <label class="relative inline-flex items-center">
                        <input type="checkbox" id="shareLocation" checked class="sr-only peer">
                        <div class="w-8 h-4 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <div class="bg-white p-2 rounded border border-gray-200">
                <label class="block text-xs mb-1">Transport</label>
                <select id="transportMode" class="w-full text-xs border-gray-300 rounded">
                    <option value="walk">Walk</option>
                    <option value="bike">Bike</option>
                </select>
            </div>

            <div class="bg-white p-2 rounded border border-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-xs">First Aid</span>
                    <label class="relative inline-flex items-center">
                        <input type="checkbox" id="firstAid" class="sr-only peer">
                        <div class="w-8 h-4 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-red-600"></div>
                    </label>
                </div>
            </div>

            <div class="bg-white p-2 rounded border border-gray-200 flex items-center">
                <button onclick="updateCrewStatus()" class="w-full py-1 bg-blue-500 text-white text-xs rounded">
                    Update
                </button>
            </div>
        </div>

        <!-- Emergency Alerts -->
        <div id="emergencyPanel" class="hidden mb-2">
            <div class="bg-red-50 border border-red-200 rounded p-2">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-sm font-bold text-red-700">EMERGENCY</h2>
                    <span id="emergencyCount" class="bg-red-500 text-white px-2 py-0.5 rounded text-xs">0</span>
                </div>
                <div id="emergencyList" class="space-y-1 max-h-32 overflow-y-auto">
                    <!-- Emergencies here -->
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="mb-2">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-sm font-semibold">Live Map</h2>
                <div class="flex space-x-1">
                    <button onclick="centerOnMyLocation()" class="px-2 py-0.5 bg-blue-500 text-white text-xs rounded">
                        My Location
                    </button>
                </div>
            </div>
            <div id="map" class="rounded border border-gray-300"></div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="bg-white p-2 rounded border border-gray-200">
                <div class="text-sm font-bold text-gray-900" id="runnerCount">0</div>
                <div class="text-xs text-gray-600">Runners</div>
            </div>
            <div class="bg-white p-2 rounded border border-gray-200">
                <div class="text-sm font-bold text-gray-900" id="crewCount">0</div>
                <div class="text-xs text-gray-600">Crew</div>
            </div>
        </div>

        <!-- Runners List -->
        <div class="bg-white p-2 rounded border border-gray-200">
            <h3 class="text-sm font-semibold mb-1">Runners</h3>
            <div id="runnersList" class="space-y-1 max-h-32 overflow-y-auto">
                <!-- Runners here -->
            </div>
        </div>
    </div>

    <script>
        // Variables
        let socket = null;
        let map = null;
        let crewMarker = null;
        let runnerMarkers = {};
        let crewMarkers = {};
        let emergencyMarkers = {};
        let crewPosition = null;
        let crewData = {
            transport: 'walk',
            first_aid: false,
            share_location: true
        };
        let runners = {};
        let allCrew = {};
        let emergencies = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initWebSocket();
            startLocationTracking();
            setupEventListeners();
        });

        // Initialize map
        function initMap() {
            map = L.map('map').setView([25.0338, 121.5645], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
        }

        // Update crew marker
        function updateCrewMarker() {
            if (!crewPosition) return;
            
            let iconClass = 'crew-walk';
            let iconText = 'W';
            
            if (crewData.transport === 'bike') {
                iconClass = 'crew-bike';
                iconText = 'B';
            }
            
            if (crewData.first_aid) {
                iconClass = 'crew-aid';
                iconText = 'A';
            }
            
            if (!crewMarker) {
                crewMarker = L.marker([crewPosition.lat, crewPosition.lng], {
                    icon: L.divIcon({
                        html: `<div class="w-8 h-8 rounded-full ${iconClass} flex items-center justify-center text-sm">${iconText}</div>`,
                        className: 'custom-div-icon',
                        iconSize: [32, 32]
                    })
                }).addTo(map);
            } else {
                crewMarker.setLatLng([crewPosition.lat, crewPosition.lng]);
                crewMarker.setIcon(L.divIcon({
                    html: `<div class="w-8 h-8 rounded-full ${iconClass} flex items-center justify-center text-sm">${iconText}</div>`,
                    className: 'custom-div-icon',
                    iconSize: [32, 32]
                }));
            }
        }

        // Location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                { enableHighAccuracy: true }
            );
            
            setInterval(sendLocationUpdate, 10000);
        }

        function handlePositionUpdate(position) {
            crewPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            updateCrewMarker();
            sendLocationUpdate();
        }

        function handlePositionError(error) {
            console.error('GPS error:', error);
        }

        // WebSocket
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketUrl = `${protocol}//${host}`;
            
            socket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true
            });
            
            // Event handlers
            socket.on('connect', handleSocketConnect);
            socket.on('disconnect', handleSocketDisconnect);
            socket.on('connected', handleConnected);
            socket.on('registration_success', handleRegistrationSuccess);
            socket.on('initial_data', handleInitialData);
            socket.on('user_location_updated', handleUserLocationUpdated);
            socket.on('crew_location_updated', handleCrewLocationUpdated);
            socket.on('user_joined', handleUserJoined);
            socket.on('user_left', handleUserLeft);
            socket.on('crew_joined', handleCrewJoined);
            socket.on('crew_left', handleCrewLeft);
            socket.on('emergency_alert', handleEmergencyAlert);
            socket.on('emergency_resolved', handleEmergencyResolved);
        }

        function handleSocketConnect() {
            updateConnectionStatus('text-yellow-500');
        }

        function handleSocketDisconnect() {
            updateConnectionStatus('text-red-500');
        }

        function handleConnected(data) {
            updateConnectionStatus('text-green-500');
            
            socket.emit('register_crew', {
                location: crewPosition ? [crewPosition.lat, crewPosition.lng] : [25.0338, 121.5645],
                transport: crewData.transport,
                first_aid: crewData.first_aid,
                share_location: crewData.share_location
            });
            
            socket.emit('get_initial_data');
        }

        function handleRegistrationSuccess(data) {
            // No action needed
        }

        function handleInitialData(data) {
            // Clear markers
            Object.values(runnerMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(crewMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(emergencyMarkers).forEach(marker => map.removeLayer(marker));
            runnerMarkers = {};
            crewMarkers = {};
            emergencyMarkers = {};
            
            // Store data
            runners = data.users;
            allCrew = data.crew;
            emergencies = data.emergencies;
            
            // Add runners
            Object.entries(runners).forEach(([runnerId, runner]) => {
                addRunnerMarker(runnerId, runner);
            });
            
            // Add other crew
            Object.entries(allCrew).forEach(([crewId, crew]) => {
                if (crewId !== socket.id) {
                    addOtherCrewMarker(crewId, crew);
                }
            });
            
            // Add emergencies
            Object.entries(emergencies).forEach(([emergencyId, emergency]) => {
                addEmergencyMarker(emergencyId, emergency);
            });
            
            // Update UI
            updateStats();
            updateRunnersList();
            updateEmergencyList();
        }

        function addRunnerMarker(runnerId, runner) {
            const isEmergency = runner.emergency || emergencies[runnerId];
            const markerClass = isEmergency ? 'emergency-icon' : 'runner-icon';
            
            if (runnerMarkers[runnerId]) {
                runnerMarkers[runnerId].setLatLng([runner.location[0], runner.location[1]]);
                runnerMarkers[runnerId].setStyle({
                    fillColor: isEmergency ? '#EF4444' : '#3B82F6',
                    color: isEmergency ? '#DC2626' : '#1D4ED8',
                    className: markerClass
                });
            } else {
                const marker = L.circleMarker([runner.location[0], runner.location[1]], {
                    radius: 8,
                    fillColor: isEmergency ? '#EF4444' : '#3B82F6',
                    color: isEmergency ? '#DC2626' : '#1D4ED8',
                    weight: 2,
                    fillOpacity: 0.8,
                    className: markerClass
                }).addTo(map);
                
                runnerMarkers[runnerId] = marker;
            }
        }

        function addOtherCrewMarker(crewId, crew) {
            let iconClass = 'crew-walk';
            let iconText = 'W';
            
            if (crew.transport === 'bike') {
                iconClass = 'crew-bike';
                iconText = 'B';
            }
            
            if (crew.first_aid) {
                iconClass = 'crew-aid';
                iconText = 'A';
            }
            
            if (crewMarkers[crewId]) {
                crewMarkers[crewId].setLatLng([crew.location[0], crew.location[1]]);
            } else {
                const marker = L.marker([crew.location[0], crew.location[1]], {
                    icon: L.divIcon({
                        html: `<div class="w-6 h-6 rounded-full ${iconClass} flex items-center justify-center text-xs">${iconText}</div>`,
                        className: 'custom-div-icon',
                        iconSize: [24, 24]
                    })
                }).addTo(map);
                
                crewMarkers[crewId] = marker;
            }
        }

        function addEmergencyMarker(emergencyId, emergency) {
            if (emergencyMarkers[emergencyId]) {
                emergencyMarkers[emergencyId].setLatLng(emergency.location);
            } else {
                const marker = L.marker(emergency.location, {
                    icon: L.divIcon({
                        html: `<div class="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center text-sm">!</div>`,
                        className: 'custom-div-icon',
                        iconSize: [40, 40]
                    })
                }).addTo(map);
                
                emergencyMarkers[emergencyId] = marker;
            }
        }

        // Control functions
        function setupEventListeners() {
            document.getElementById('shareLocation').addEventListener('change', function() {
                crewData.share_location = this.checked;
                sendLocationUpdate();
            });
            
            document.getElementById('firstAid').addEventListener('change', function() {
                crewData.first_aid = this.checked;
                updateCrewMarker();
                sendLocationUpdate();
            });
        }

        function updateCrewStatus() {
            const transport = document.getElementById('transportMode').value;
            const firstAid = document.getElementById('firstAid').checked;
            const shareLocation = document.getElementById('shareLocation').checked;
            
            crewData.transport = transport;
            crewData.first_aid = firstAid;
            crewData.share_location = shareLocation;
            
            updateCrewMarker();
            sendLocationUpdate();
        }

        // Emergency functions
        function handleEmergencyAlert(data) {
            emergencies[data.emergency_id] = data;
            addEmergencyMarker(data.emergency_id, data);
            updateStats();
            updateEmergencyList();
            
            // Show notification
            alert(`EMERGENCY: Runner needs help!`);
        }

        function handleEmergencyResolved(data) {
            if (emergencyMarkers[data.emergency_id]) {
                map.removeLayer(emergencyMarkers[data.emergency_id]);
                delete emergencyMarkers[data.emergency_id];
            }
            
            delete emergencies[data.emergency_id];
            updateStats();
            updateEmergencyList();
        }

        // UI updates
        function updateConnectionStatus(color) {
            const icon = document.querySelector('#connectionStatus i');
            icon.className = `fas fa-wifi ${color}`;
        }

        function sendLocationUpdate() {
            if (!crewPosition || !socket || !socket.connected) return;
            
            socket.emit('crew_location_update', {
                lat: crewPosition.lat,
                lng: crewPosition.lng,
                transport: crewData.transport,
                first_aid: crewData.first_aid,
                share_location: crewData.share_location
            });
        }

        function centerOnMyLocation() {
            if (crewPosition) {
                map.setView([crewPosition.lat, crewPosition.lng], 16);
            }
        }

        function updateStats() {
            document.getElementById('runnerCount').textContent = Object.keys(runners).length;
            document.getElementById('crewCount').textContent = Object.keys(allCrew).length + 1;
            document.getElementById('emergencyCount').textContent = Object.keys(emergencies).length;
            
            if (Object.keys(emergencies).length > 0) {
                document.getElementById('emergencyPanel').classList.remove('hidden');
            } else {
                document.getElementById('emergencyPanel').classList.add('hidden');
            }
        }

        function updateRunnersList() {
            const container = document.getElementById('runnersList');
            container.innerHTML = '';
            
            Object.entries(runners).forEach(([runnerId, runner]) => {
                const isEmergency = runner.emergency || emergencies[runnerId];
                const item = document.createElement('div');
                item.className = `text-xs p-1 rounded ${isEmergency ? 'bg-red-100' : 'bg-gray-100'}`;
                item.textContent = `Runner${isEmergency ? ' (EMERGENCY)' : ''}`;
                container.appendChild(item);
            });
            
            if (Object.keys(runners).length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500">No runners</div>';
            }
        }

        function updateEmergencyList() {
            const container = document.getElementById('emergencyList');
            container.innerHTML = '';
            
            Object.values(emergencies).forEach(emergency => {
                const item = document.createElement('div');
                item.className = 'text-xs p-1 bg-white rounded border border-red-200';
                item.innerHTML = `
                    <div class="font-bold text-red-700">EMERGENCY</div>
                    <div class="text-gray-600">Runner needs help</div>
                `;
                container.appendChild(item);
            });
        }

        // Other handlers
        function handleUserLocationUpdated(data) {
            if (runners[data.sid]) {
                runners[data.sid].location = data.location;
                runners[data.sid].emergency = data.emergency;
                addRunnerMarker(data.sid, runners[data.sid]);
                updateRunnersList();
            }
        }

        function handleCrewLocationUpdated(data) {
            if (data.sid === socket.id) return;
            
            if (allCrew[data.sid]) {
                allCrew[data.sid] = { ...allCrew[data.sid], ...data };
                addOtherCrewMarker(data.sid, allCrew[data.sid]);
            }
        }

        function handleUserJoined(data) {
            runners[data.sid] = data;
            addRunnerMarker(data.sid, data);
            updateStats();
            updateRunnersList();
        }

        function handleUserLeft(data) {
            if (runnerMarkers[data.sid]) {
                map.removeLayer(runnerMarkers[data.sid]);
                delete runnerMarkers[data.sid];
            }
            delete runners[data.sid];
            updateStats();
            updateRunnersList();
        }

        function handleCrewJoined(data) {
            if (data.sid !== socket.id) {
                allCrew[data.sid] = data;
                addOtherCrewMarker(data.sid, data);
                updateStats();
            }
        }

        function handleCrewLeft(data) {
            if (crewMarkers[data.sid]) {
                map.removeLayer(crewMarkers[data.sid]);
                delete crewMarkers[data.sid];
            }
            delete allCrew[data.sid];
            updateStats();
        }
    </script>
</body>
</html>